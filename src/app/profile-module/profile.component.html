<!-- Profile -->
<div class="container" *ngIf="identity && ownProfile">
    <section id="profile">

        <div class="container-fluid card rounded overflow-hidden bg-white profile-header-card">

            <div class="row bg-primary">
                <div class="col">
                    <div class="card border-0">
                        <div class="card-body bg-primary p-4">
                            
                            <!-- Layout horizontal centrado: Foto + Info + Contadores -->
                            <div class="row align-items-center justify-content-center">
                                
                                <!-- Columna 1: Foto de perfil -->
                                <div class="col-lg-3 col-md-3 text-center">
                                    <div class="profile-picture-container-compact">
                                        <img *ngIf="!ownProfile?.picture" 
                                             class="profile-picture-compact"
                                             src="assets/images/user-default.png"
                                             alt="Imagen por defecto">
                                        <img *ngIf="ownProfile?.picture" 
                                             class="profile-picture-compact"
                                             [src]="url + 'get-image-user/' + ownProfile.picture + '?v=' + profilePicVersion"
                                             alt="Foto de perfil">
                                    </div>
                                    
                                    <!-- Botón de acción debajo de la foto -->
                                    <div class="mt-3">
                                        <button *ngIf="identity?._id == ownProfile?._id" 
                                                class="btn btn-danger btn-profile-action-compact"
                                                [routerLink]="['/perfil/', ownProfile._id, 'editar']"> 
                                            <i class="fas fa-edit me-2"></i>Editar perfil
                                        </button>

                                        <button *ngIf="identity?._id != ownProfile?._id && !following" 
                                                class="btn btn-follow-primary btn-profile-action-compact" 
                                                (click)="followUser(ownProfile._id.toString())">
                                            <i class="fas fa-user-plus me-2"></i>Seguir
                                        </button>

                                        <button *ngIf="identity?._id != ownProfile?._id && following" 
                                                type="button" 
                                                class="btn btn-following btn-profile-action-compact"
                                                (mouseenter)="mouseEnter(ownProfile._id.toString())" 
                                                (mouseleave)="mouseLeave()"
                                                [class.btn-unfollow]="ownProfile._id == followUserOver"
                                                (click)="openUnfollowModal(ownProfile._id.toString())">
                                            <span *ngIf="ownProfile._id == followUserOver; else followingTemplate">
                                                <i class="fas fa-user-minus me-2"></i>Dejar de seguir
                                            </span>
                                            <ng-template #followingTemplate>
                                                <span>
                                                    <i class="fas fa-user-check me-2"></i>Siguiendo
                                                </span>
                                            </ng-template>
                                        </button>

                                        <!-- Botón de denuncia (solo si es otro usuario) -->
                                        <a *ngIf="identity?._id != ownProfile?._id" 
                                           class="btn btn-outline-warning btn-profile-action-compact mt-2"
                                           [routerLink]="['/error','report-error']"
                                           [queryParams]="{ category: 'user', reportedUserId: ownProfile._id }"
                                           title="Denunciar usuario">
                                            <i class="fas fa-exclamation-triangle me-2"></i>Denunciar usuario
                                        </a>
                                    </div>
                                </div>

                                <!-- Columna 2: Información del usuario -->
                                <div class="col-lg-5 col-md-5 text-center text-lg-start">
                                    <div class="profile-info-compact text-white">
                                        <h2 class="text-white text-capitalize mb-2">
                                            <strong>{{ownProfile?.name}} {{ownProfile?.surname}}</strong>
                                        </h2>
                                        <div class="mb-3">
                                            <span *ngIf="ownProfile?.role && hasRoleCategory(ownProfile.role.toString())" 
                                                  [class]="'badge role-badge role-' + ownProfile.role.toString().toLowerCase() + ' ' + getRoleClass(ownProfile.role.toString())">
                                                  <i class="fas fa-user-tag me-1"></i>{{getRoleLabel(ownProfile.role.toString())}}
                                            </span>
                                        </div>

                                        <!-- Información profesional compacta -->
                                        <div class="profile-professional-info-compact">
                                            <p *ngIf="ownProfile?.profession" class="mb-1">
                                                <small><i class="fas fa-briefcase me-2"></i>{{ownProfile.profession.name}}</small>
                                            </p>
                                            <p *ngIf="ownProfile?.institution" class="mb-1">
                                                <small><i class="fas fa-university me-2"></i>{{ownProfile.institution.name}}</small> 
                                            </p>
                                            <p *ngIf="ownProfile?.city" class="mb-1">
                                                <small><i class="fas fa-map-marker-alt me-2"></i>{{ownProfile.city.name}}, {{ownProfile.city.state}}, {{ownProfile.city.country}}</small>
                                            </p>
                                        </div>
                                    </div>
                                </div>

                                <!-- Columna 3: Contadores compactos reorganizados -->
                                <div class="col-lg-4 col-md-4">
                                    <div class="row text-white counters-compact justify-content-center">
                                        
                                        <!-- Primera fila: Publicaciones y Lecciones -->
                                        <div class="col-6 mb-3">
                                            <div class="counter-compact text-center" 
                                                 (click)="goToPublications()"
                                                 title="Ver publicaciones">
                                                <div class="counter-number-compact">{{counters?.publications || 0}}</div>
                                                <div class="counter-label-compact">Publicaciones</div>
                                            </div>
                                        </div>

                                        <div class="col-6 mb-3">
                                            <div class="counter-compact text-center" 
                                                 (click)="goToLessons()"
                                                 title="Ver lecciones">
                                                <div class="counter-number-compact">{{counters?.lessons || 0}}</div>
                                                <div class="counter-label-compact">Lecciones</div>
                                            </div>
                                        </div>
                                        
                                        <!-- Segunda fila: Seguidores y Siguiendo -->
                                        <div class="col-6 mb-3">
                                            <div class="counter-compact text-center" 
                                                 (click)="showFollowers()"
                                                 title="Ver seguidores">
                                                <div class="counter-number-compact">{{counters?.followed || 0}}</div>
                                                <div class="counter-label-compact">Seguidores</div>
                                            </div>
                                        </div>

                                        <div class="col-6 mb-3">
                                            <div class="counter-compact text-center" 
                                                 (click)="showFollowing()"
                                                 title="Ver siguiendo">
                                                <div class="counter-number-compact">{{counters?.following || 0}}</div>
                                                <div class="counter-label-compact">Siguiendo</div>
                                            </div>
                                        </div>

                                    </div>
                                </div>

                            </div>

                        </div>
                    </div>
                </div>
            </div>

        </div>

    </section>

    <section id="menu" class="mt-0">

        <nav class="navbar navbar-expand-lg rounded profile-menu-nav" style="border: 1px solid #dee2e6;"
             [class.navbar-light]="true"
             [class.bg-white]="true"
             [class.navbar-dark]="false"
             [class.bg-dark]="false">

            <div class="container-fluid">
                <ul class="navbar-nav me-auto mb-2 mb-lg-0 w-100 justify-content-around" style="justify-content: space-evenly;">

                    <li class="nav-item" *ngFor="let menu of menuOptions">
                        <a class="nav-link" [routerLink]="['/perfil/', ownProfile?._id, menu.value]"
                            [queryParams]="menu.value === 'publicaciones' ? { scrollTo: 'top' } : {}"
                            routerLinkActive="active" [routerLinkActiveOptions]="{exact:true}">
                            <i class="{{menu.icon}} me-2"></i>{{menu.name}}
                        </a>
                    </li>

                </ul>
            </div>

        </nav>

    </section>

    <!-- Layout de dos columnas -->
    <section id="content" class="mt-0">
        <div class="row">
            <!-- Columna izquierda: Información fija del perfil -->
            <div class="col-lg-4 col-md-5">
                <div class="profile-sidebar">
                    <!-- Acerca de -->
                    <div class="card mb-3" *ngIf="ownProfile?.about && (identity?._id === ownProfile?._id || identity?.actived === true)">
                        <div class="card-header bg-info text-white">
                            <h6 class="mb-0">
                                <i class="fas fa-user-circle me-2"></i>Acerca de
                            </h6>
                        </div>
                        <div class="card-body">
                            <div class="profile-about-content" [class.expanded]="aboutExpanded">
                                <p *ngFor="let text of (aboutExpanded ? (ownProfile?.about || '') : (about || '')).split('\n')" 
                                   class="text-break mb-1 lh-sm" 
                                   [class.mb-0]="text === ''">
                                    <span>{{text}}</span>                        
                                </p>
                            </div>
                            <div class="mt-2 d-flex justify-content-between">
                                <button *ngIf="ownProfile.about && ownProfile.about.length > 200" 
                                        class="btn btn-sm btn-outline-primary"
                                        (click)="toggleAbout()">
                                    <i class="fas" [class.fa-expand-alt]="!aboutExpanded" [class.fa-compress-alt]="aboutExpanded" class="me-1"></i>
                                    {{aboutExpanded ? 'Mostrar menos' : 'Mostrar más'}}
                                </button>
                                <button class="btn btn-sm btn-info"
                                        [routerLink]="['/perfil/', ownProfile._id, 'info']"
                                        title="Ver información completa del perfil">
                                    <i class="fas fa-info-circle me-1"></i>Información completa
                                </button>
                            </div>
                        </div>
                    </div>

                    <!-- Redes sociales -->
                    <div class="card mb-3" *ngIf="ownProfile?.socialNetworks && (identity?._id === ownProfile?._id || identity?.actived === true)">
                        <div class="card-header bg-info text-white">
                            <h6 class="mb-0">
                                <i class="fas fa-share-alt me-2"></i>Redes sociales
                            </h6>
                        </div>
                        <div class="card-body">
                            <div class="social-link-item mb-2" *ngFor="let link of getSocialLinks(ownProfile.socialNetworks)">
                                <a [href]="formatLink(link)" 
                                   target="_blank" 
                                   [title]="'Visitar ' + link.trim()" 
                                   class="text-decoration-none text-primary d-flex align-items-center p-2 border rounded bg-light">
                                    <i class="fas fa-external-link-alt me-2"></i>
                                    <span class="text-truncate">{{ link.trim() }}</span>
                                </a>
                            </div>
                        </div>
                    </div>

                    <!-- Mensaje para usuarios no activos/no dueños -->
                    <div class="card mb-3" *ngIf="!(identity?._id === ownProfile?._id || identity?.actived === true)">
                        <div class="card-header bg-warning text-dark">
                            <h6 class="mb-0">
                                <i class="fas fa-lock me-2"></i>Información restringida
                            </h6>
                        </div>
                        <div class="card-body">
                            <p class="mb-0">Debes tener una cuenta activa para ver los detalles del perfil.</p>
                        </div>
                    </div>

                </div>
            </div>

            <!-- Columna derecha: Contenido dinámico -->
            <div class="col-lg-8 col-md-7">
                <div class="profile-content">
                    <router-outlet></router-outlet>
                </div>
            </div>
        </div>
    </section>

    <!-- Botón flotante para volver a publicaciones -->
    <button *ngIf="shouldShowFloatingButton()" 
            class="btn floating-publications-btn position-fixed rounded-circle shadow-lg d-flex align-items-center justify-content-center"
            [routerLink]="['/perfil/', ownProfile?._id, 'publicaciones']"
            [queryParams]="{ scrollTo: 'top' }"
            title="Volver a publicaciones">
        <i class="fas fa-newspaper fa-lg"></i>
    </button>

</div>

<!-- Loading o error state -->
<div class="container" *ngIf="!identity || !ownProfile">
    <div class="text-center mt-5">
        <div class="spinner-border text-primary" role="status" *ngIf="!status">
            <span class="visually-hidden">Cargando...</span>
        </div>
        <div *ngIf="status === 'error'" class="alert alert-danger mt-3">
            <h4>Error al cargar el perfil</h4>
            <p>No se pudo cargar la información del usuario. Por favor, inténtalo de nuevo.</p>
            <button class="btn btn-primary" (click)="loadPage()">Reintentar</button>
        </div>
    </div>
</div>

<!-- Modal warning left group -->
<div class="modal fade" id="unfollowus" tabindex="-1" role="dialog" aria-labelledby="unfollowUsuario" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="unfollowUsr">Dejar de seguir a esta persona</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>

            <div class="modal-body">
                <div class="alert alert-warning mb-0" role="alert">
                    <i class="fas fa-exclamation-triangle icon-message me-2"></i>
                    No verás sus publicaciones ni su actividad en el inicio de Reddinámica, ¿deseas continuar?
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-danger" data-bs-dismiss="modal" (click)="unfollow()">Sí</button>
                <button class="btn btn-primary text-white" data-bs-dismiss="modal">No</button>
            </div>

        </div>
    </div>
</div>
<!-- /Modal warning-->