<div class="group-detail-container">
  <!-- Loading spinner -->
  <div *ngIf="loading" class="loading-container">
    <div class="spinner-border" role="status">
      <span class="visually-hidden">Cargando...</span>
    </div>
  </div>

  <!-- Error message -->
  <div *ngIf="error" class="alert alert-danger">
    {{ error }}
  </div>

  <!-- Group details -->
  <div *ngIf="!loading && group" class="group-content">
    <!-- Header (Modo visualización) -->
    <div class="group-header" *ngIf="!editMode">
      <div class="group-info">
        <h1>{{ group.name }}</h1>
        <p class="group-description">{{ group.description }}</p>
        <div class="group-meta">
          <span class="badge bg-primary">{{ getAcademicLevelLabel(group.academicLevel) }}</span>
          <span class="badge bg-secondary">{{ group.grade }}</span>
          <span class="badge bg-info text-dark">{{ group.academicYear }}</span>
          <span class="badge" [ngClass]="group.isActive ? 'bg-success' : 'bg-danger'">
            {{ group.isActive ? 'Activo' : 'Inactivo' }}
          </span>
        </div>
      </div>
      
      <div class="group-actions" *ngIf="canEditGroup()">
        <button class="btn btn-primary" (click)="editGroup()">
          <i class="fas fa-edit"></i> Editar
        </button>
        <button class="btn btn-danger" (click)="deleteGroup()">
          <i class="fas fa-trash"></i> Eliminar
        </button>
      </div>
    </div>

    <!-- Header (Modo edición) -->
    <div class="group-header" *ngIf="editMode">
      <div class="group-info w-100">
        <h3 class="mb-3">Editar Grupo</h3>
        <div class="mb-3">
          <label class="form-label">Nombre del Grupo *</label>
          <input type="text" class="form-control" [(ngModel)]="editedGroup.name" placeholder="Nombre del grupo" />
        </div>
        <!-- Líder (solo admins/gestores) -->
        <div class="mb-3" *ngIf="allowOwnerChange">
          <label class="form-label"><strong>Líder (Docente/Facilitador)</strong></label>
          <div class="mb-2">
            <small class="text-muted">Líder actual: {{ getLeaderName() }}</small>
          </div>
          <div class="position-relative">
            <input
              type="text"
              class="form-control"
              [(ngModel)]="ownerSearchTerm"
              (ngModelChange)="onOwnerSearchInputChange()"
              placeholder="Buscar docente o facilitador por nombre o email..."
              autocomplete="off"
            />
            <div *ngIf="showOwnerDropdown" class="dropdown-menu show position-absolute w-100 mt-1" style="z-index: 1050; max-height: 220px; overflow-y: auto;">
              <button
                *ngFor="let u of ownerSearchResults"
                type="button"
                class="dropdown-item"
                (click)="selectNewOwner(u)"
              >
                {{u.name}} {{u.surname}} <small class="text-muted">({{u.email}})</small>
              </button>
            </div>
          </div>
          <div class="mt-2" *ngIf="selectedNewOwner">
            <span class="badge bg-info">Nuevo líder: {{selectedNewOwner.name}} {{selectedNewOwner.surname}}</span>
            <button class="btn btn-sm btn-outline-primary ms-2" type="button" (click)="transferOwnership(selectedNewOwner._id)" [disabled]="savingGroup">
              Cambiar líder
            </button>
          </div>
        </div>
        <div class="mb-3">
          <label class="form-label">Descripción *</label>
          <textarea class="form-control" rows="3" [(ngModel)]="editedGroup.description" placeholder="Descripción del grupo"></textarea>
        </div>
        <div class="row">
          <div class="col-md-6 mb-3">
            <label class="form-label">Nivel Académico *</label>
            <select class="form-control" [(ngModel)]="editedGroup.academicLevel" (change)="loadValidGrades(editedGroup.academicLevel)">
              <option value="">Seleccionar nivel</option>
              <option value="Colegio">Colegio</option>
              <option value="Universidad">Universidad</option>
            </select>
          </div>
          <div class="col-md-6 mb-3">
            <label class="form-label">Grado *</label>
            <select class="form-control" [(ngModel)]="editedGroup.grade">
              <option value="">Seleccionar grado</option>
              <option *ngFor="let grade of validGrades" [value]="grade">{{ grade }}</option>
            </select>
          </div>
        </div>
        <div class="mb-3">
          <label class="form-label">Máximo de Estudiantes</label>
          <input type="number" class="form-control" [(ngModel)]="editedGroup.maxStudents" min="1" max="100" />
        </div>
        <div class="d-flex gap-2">
          <button class="btn btn-success" [disabled]="savingGroup" (click)="saveGroup()">
            <span *ngIf="savingGroup" class="spinner-border spinner-border-sm me-2"></span>
            <i class="fas fa-save" *ngIf="!savingGroup"></i>
            Guardar Cambios
          </button>
          <button class="btn btn-secondary" (click)="cancelEdit()">
            <i class="fas fa-times"></i>
            Cancelar
          </button>
        </div>
      </div>
    </div>

    <!-- Statistics -->
    <div class="statistics-section">
      <div class="stat-card">
        <div class="stat-icon">
          <i class="fas fa-users"></i>
        </div>
        <div class="stat-content">
          <h3>{{ students.length }}</h3>
          <p>Estudiantes</p>
        </div>
      </div>
      
      <div class="stat-card">
        <div class="stat-icon">
          <i class="fas fa-book"></i>
        </div>
        <div class="stat-content">
          <h3>{{ lessons.length }}</h3>
          <p>Lecciones</p>
        </div>
      </div>
      
      <div class="stat-card">
        <div class="stat-icon">
          <i class="fas fa-chart-line"></i>
        </div>
        <div class="stat-content">
          <h3>{{ group.maxStudents }}</h3>
          <p>Capacidad Máxima</p>
        </div>
      </div>
    </div>

    <!-- Tabs -->
    <div class="tabs-section">
      <ul class="nav nav-tabs" id="groupTabs" role="tablist">
        <li class="nav-item" role="presentation">
          <button class="nav-link active" id="lessons-tab" data-bs-toggle="tab" data-bs-target="#lessons" type="button" role="tab">
            <i class="fas fa-book"></i> Lecciones
          </button>
        </li>
        <li class="nav-item" role="presentation">
          <button class="nav-link" id="students-tab" data-bs-toggle="tab" data-bs-target="#students" type="button" role="tab">
            <i class="fas fa-users"></i> Estudiantes
          </button>
        </li>
        <li class="nav-item" role="presentation">
          <button class="nav-link" id="discussion-tab" data-bs-toggle="tab" data-bs-target="#discussion" type="button" role="tab">
            <i class="fas fa-comments"></i> Discusión
          </button>
        </li>
        <li class="nav-item" role="presentation">
          <button class="nav-link" id="resources-tab" data-bs-toggle="tab" data-bs-target="#resources" type="button" role="tab">
            <i class="fas fa-folder-open"></i> Recursos
          </button>
        </li>
      </ul>

      <div class="tab-content" id="groupTabsContent">
        <!-- Lessons Tab -->
        <div class="tab-pane fade show active" id="lessons" role="tabpanel">
          <div class="tab-header">
            <h3>Lecciones del Grupo</h3>
            <button *ngIf="canCreateLesson()" class="btn btn-primary" (click)="createLesson()">
              <i class="fas fa-plus"></i> Crear Lección
            </button>
          </div>

          <div *ngIf="lessons.length === 0" class="empty-state">
            <div class="empty-icon">
              <i class="fas fa-book"></i>
            </div>
            <h4>No hay lecciones</h4>
            <p>Este grupo aún no tiene lecciones creadas.</p>
            <button *ngIf="canCreateLesson()" class="btn btn-primary" (click)="createLesson()">
              Crear Primera Lección
            </button>
          </div>

          <div *ngIf="lessons.length > 0" class="lessons-grid">
            <div *ngFor="let lesson of lessons" class="lesson-card">
              <div class="lesson-header">
                <h4>{{ lesson.title }}</h4>
                <span class="badge" [ngClass]="getStatusBadgeClass(lesson.status)">
                  {{ getStatusLabel(lesson.status) }}
                </span>
              </div>
              
              <div class="lesson-content">
                <p>{{ lesson.resume }}</p>
                <div class="lesson-meta">
                  <small><i class="fas fa-user"></i> {{ getAuthorName(lesson) }}</small>
                </div>
              </div>
              
              <div class="lesson-actions">
                <button class="btn btn-sm btn-outline-primary" (click)="viewLesson(lesson._id)">
                  <i class="fas fa-eye"></i> Ver
                </button>
              </div>
            </div>
          </div>
        </div>

        <!-- Students Tab -->
        <div class="tab-pane fade" id="students" role="tabpanel">
          <app-group-students 
            [groupId]="groupId"
            [students]="students"
            [userRole]="userRole"
            [currentUserRole]="currentUserRole"
            [teacherId]="group?.teacher"
            [currentUserId]="currentUserId"
            (studentsUpdated)="onStudentsUpdated()">
          </app-group-students>
        </div>

        <!-- Discussion Tab (Sistema de Foro) -->
        <div class="tab-pane fade" id="discussion" role="tabpanel">
          <app-group-discussion
            [groupId]="groupId"
            [userRole]="userRole"
            [currentUserId]="currentUserId"
            [teacherId]="group?.teacher"
            [canPostInForum]="canPostInForum()">
          </app-group-discussion>
        </div>

        <!-- Resources Tab -->
        <div class="tab-pane fade" id="resources" role="tabpanel">
          <app-group-resources
            [groupId]="groupId"
            [groupResources]="groupResources"
            [userRole]="userRole"
            [token]="token"
            [teacherId]="group?.teacher"
            [currentUserId]="currentUserId"
            (resourcesUpdated)="onResourcesUpdated()">
          </app-group-resources>
        </div>
      </div>
    </div>
  </div>
</div>
