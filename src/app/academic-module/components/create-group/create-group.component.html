<div class="create-group-container">
  <div class="header">
    <h2>Crear Nuevo Grupo Académico</h2>
    <button class="btn btn-secondary" (click)="cancel()">
      <i class="fas fa-arrow-left"></i> Volver
    </button>
  </div>

  <!-- Mensajes de éxito y error -->
  <div *ngIf="successMessage" class="alert alert-success" #successAlert tabindex="-1" role="status" aria-live="polite">
    {{ successMessage }}
  </div>

  <div *ngIf="errorMessage" class="alert alert-danger">
    {{ errorMessage }}
  </div>

  <div class="form-container">
    <form [formGroup]="groupForm" (ngSubmit)="onSubmit()" class="group-form">
      
      <!-- Nombre del grupo -->
      <div class="mb-3">
        <label for="name">Nombre del Grupo *</label>
        <input 
          type="text" 
          id="name"
          formControlName="name"
          class="form-control"
          [class.is-invalid]="isFieldInvalid('name')"
          placeholder="Ej: Matemáticas Avanzadas 2024">
        <div *ngIf="isFieldInvalid('name')" class="invalid-feedback">
          {{ getErrorMessage('name') }}
        </div>
      </div>

      <!-- Descripción -->
      <div class="mb-3">
        <label for="description">Descripción *</label>
        <textarea 
          id="description"
          formControlName="description"
          class="form-control"
          [class.is-invalid]="isFieldInvalid('description')"
          rows="4"
          placeholder="Describe el propósito y objetivos del grupo..."></textarea>
        <div *ngIf="isFieldInvalid('description')" class="invalid-feedback">
          {{ getErrorMessage('description') }}
        </div>
      </div>

      <!-- Materias (con autocompletado y chips) -->
      <div class="mb-3">
        <label class="form-label"><strong>Materias<span class="text-danger">*</span></strong></label>

        <!-- Chips seleccionados -->
        <div class="selected-items-container mb-2" *ngIf="selectedSubjects.length > 0">
          <span *ngFor="let s of selectedSubjects" class="badge bg-primary me-1 mb-1 selected-chip">
            {{s.name}}
            <button type="button" class="btn-close btn-close-white ms-1" (click)="removeSubjectChip(s)" aria-label="Eliminar"></button>
          </span>
        </div>

        <!-- Input de autocompletado -->
        <div class="knowledge-area-autocomplete position-relative">
          <input type="text"
                 class="form-control"
                 [(ngModel)]="subjectInput"
                 [ngModelOptions]="{standalone: true}"
                 (input)="onSubjectInputChange()"
                 (keyup.enter)="addNewSubjectFromInput()"
                 [ngClass]="{'is-invalid': isFieldInvalid('subjects') && submitted}"
                 placeholder="Escribe para buscar o agregar materia..."
                 autocomplete="off">

          <!-- Dropdown de sugerencias -->
          <div *ngIf="showSubjectDropdown" class="dropdown-menu show position-absolute w-100 mt-1" style="z-index: 1050; max-height: 200px; overflow-y: auto;">
            <button *ngFor="let area of filteredSubjects"
                    type="button"
                    class="dropdown-item"
                    (click)="selectSubject(area)">
              <i class="fas fa-tag me-2"></i>
              {{area.name}}
            </button>

            <div *ngIf="subjectInput.trim() && filteredSubjects.length === 0" class="dropdown-divider"></div>
            <button *ngIf="subjectInput.trim() && filteredSubjects.length === 0"
                    type="button"
                    class="dropdown-item text-success"
                    (click)="addNewSubjectFromInput()">
              <i class="fas fa-plus me-2"></i>
              Crear "{{subjectInput}}"
            </button>
          </div>
        </div>

        <small class="form-text text-muted">Escribe para buscar materias (áreas) existentes o crear nuevas</small>
        <div *ngIf="isFieldInvalid('subjects') && submitted" class="invalid-feedback d-block">Debes añadir al menos una materia.</div>
      </div>

      <!-- Nivel académico -->
      <div class="mb-3">
        <label for="academicLevel">Nivel Académico *</label>
        <select 
          id="academicLevel"
          formControlName="academicLevel"
          class="form-control"
          [class.is-invalid]="isFieldInvalid('academicLevel')">
          <option value="">Selecciona un nivel</option>
          <option value="Colegio">Colegio</option>
          <option value="Universidad">Universidad</option>
        </select>
        <div *ngIf="isFieldInvalid('academicLevel')" class="invalid-feedback">
          {{ getErrorMessage('academicLevel') }}
        </div>
      </div>

      <!-- Grado -->
      <div class="mb-3">
        <label for="grade">Grado *</label>
        <select 
          id="grade"
          formControlName="grade"
          class="form-control"
          [class.is-invalid]="isFieldInvalid('grade')"
          [disabled]="!groupForm.get('academicLevel')?.value">
          <option value="">Selecciona un grado</option>
          <option *ngFor="let grade of validGrades" [value]="grade">
            {{ grade }}
          </option>
        </select>
        <div *ngIf="isFieldInvalid('grade')" class="invalid-feedback">
          {{ getErrorMessage('grade') }}
        </div>
        <small class="form-text text-muted" *ngIf="!groupForm.get('academicLevel')?.value">
          Primero selecciona el nivel académico
        </small>
      </div>

      <!-- Número máximo de estudiantes -->
      <div class="mb-3">
        <label for="maxStudents">Número Máximo de Estudiantes *</label>
        <input 
          type="number" 
          id="maxStudents"
          formControlName="maxStudents"
          class="form-control"
          [class.is-invalid]="isFieldInvalid('maxStudents')"
          min="1"
          max="100"
          placeholder="30">
        <div *ngIf="isFieldInvalid('maxStudents')" class="invalid-feedback">
          {{ getErrorMessage('maxStudents') }}
        </div>
        <small class="form-text text-muted">
          Máximo 100 estudiantes por grupo
        </small>
      </div>


      <!-- Botones de acción -->
      <div class="form-actions">
        <button 
          type="button" 
          class="btn btn-secondary" 
          (click)="cancel()"
          [disabled]="loading">
          Cancelar
        </button>
        <button 
          type="submit" 
          class="btn btn-primary" 
          [disabled]="loading || groupForm.invalid">
          <span *ngIf="loading" class="spinner-border spinner-border-sm me-2" role="status"></span>
          <i *ngIf="!loading" class="fas fa-save me-2"></i>
          {{ loading ? 'Creando...' : 'Crear Grupo' }}
        </button>
      </div>
    </form>
  </div>

  <!-- Información adicional -->
  <div class="info-section">
    <div class="info-card">
      <h4><i class="fas fa-info-circle"></i> Información del Grupo</h4>
      <ul>
        <li>Los grupos académicos permiten organizar a los estudiantes por nivel y grado</li>
        <li>Como profesor, tendrás acceso completo a todas las lecciones creadas por los estudiantes del grupo</li>
        <li>Puedes importar contenido de RedDinámica principal a tus grupos</li>
        <li>Las mejores lecciones pueden ser exportadas a la comunidad principal</li>
      </ul>
    </div>
  </div>
</div>
