<div class="lesson-detail-container">
  <!-- Loading spinner -->
  <div *ngIf="loading" class="loading-container">
    <div class="spinner-border text-primary" role="status">
      <span class="visually-hidden">Cargando...</span>
    </div>
  </div>

  <!-- Messages -->
  <div *ngIf="successMessage" class="alert alert-success alert-dismissible fade show" role="alert">
    <i class="fas fa-check-circle me-2"></i>{{ successMessage }}
    <button type="button" class="btn-close" (click)="successMessage = ''" aria-label="Close"></button>
  </div>

  <div *ngIf="errorMessage" class="alert alert-danger alert-dismissible fade show" role="alert">
    <i class="fas fa-exclamation-circle me-2"></i>{{ errorMessage }}
    <button type="button" class="btn-close" (click)="errorMessage = ''" aria-label="Close"></button>
  </div>

  <!-- Lesson details -->
  <div *ngIf="!loading && lesson" class="lesson-wrapper">
    <!-- Header simplificado -->
    <div class="lesson-header-card">
      <div class="d-flex justify-content-between align-items-start">
        <div class="flex-grow-1">
          <h1 class="lesson-title">{{ lesson.title }}</h1>
          <p class="lesson-description text-muted">{{ lesson.resume }}</p>
          
          <!-- Badges de información -->
          <div class="d-flex flex-wrap gap-2 mt-3">
            <span class="badge" [ngClass]="'bg-' + getStatusColor(lesson.status)">
              <i class="fas fa-circle-notch me-1"></i>{{ getStatusLabel(lesson.status) }}
            </span>
            <span class="badge bg-secondary" *ngIf="lesson.academicSettings?.academicLevel">
              <i class="fas fa-school me-1"></i>{{ lesson.academicSettings.academicLevel }}
            </span>
            <span class="badge bg-info" *ngIf="lesson.academicSettings?.grade">
              <i class="fas fa-graduation-cap me-1"></i>{{ lesson.academicSettings.grade }}
            </span>
            <span class="badge bg-warning text-dark" *ngIf="lesson.grade">
              <i class="fas fa-star me-1"></i>{{ lesson.grade }}/5
            </span>
            <span class="badge bg-success" *ngIf="lesson.isExported">
              <i class="fas fa-check-circle me-1"></i>Exportada
            </span>
            <span class="badge bg-primary" *ngIf="lesson.state === 'ready_for_migration' && !lesson.isExported">
              <i class="fas fa-hourglass-half me-1"></i>Pendiente de Exportación
            </span>
          </div>
        </div>

        <!-- Action buttons -->
        <div class="action-buttons-group">
          <button *ngIf="canEdit()" class="btn btn-outline-primary btn-sm" (click)="editLesson()" title="Editar lección">
            <i class="fas fa-edit"></i> Editar
          </button>
          <button *ngIf="canDelete()" class="btn btn-outline-danger btn-sm" (click)="deleteLesson()">
            <i class="fas fa-trash"></i> Eliminar
          </button>
          <button *ngIf="canLeaveLesson()" class="btn btn-outline-warning btn-sm" (click)="leaveLesson()">
            <i class="fas fa-sign-out-alt"></i> Retirarse
          </button>
          <!-- Botones del profesor -->
          <button *ngIf="canApprove()" class="btn btn-success btn-sm" (click)="openApproveModal()" title="Aprobar propuesta">
            <i class="fas fa-check"></i> Aprobar
          </button>
          <button *ngIf="canApprove()" class="btn btn-danger btn-sm" (click)="openRejectModal()" title="Rechazar propuesta">
            <i class="fas fa-times"></i> Rechazar
          </button>
          <button *ngIf="canGrade()" class="btn btn-primary btn-sm" (click)="openGradeModal()" title="Calificar lección">
            <i class="fas fa-clipboard-check"></i> Calificar
          </button>
          <button *ngIf="canExport()" class="btn btn-info btn-sm" (click)="exportLesson()" title="Solicitar exportación a RedDinámica">
            <i class="fas fa-paper-plane"></i> Solicitar Exportación
          </button>
        </div>
      </div>

      <!-- Info rápida -->
      <div class="quick-info mt-4">
        <div class="row g-3">
          <div class="col-md-3">
            <div class="info-card">
              <i class="fas fa-user text-primary"></i>
              <div>
                <small class="text-muted d-block">Autor</small>
                <strong>{{ displayUserName(lesson.author) }}</strong>
              </div>
            </div>
          </div>
          <div class="col-md-3">
            <div class="info-card">
              <i class="fas fa-users text-success"></i>
              <div>
                <small class="text-muted d-block">Grupo</small>
                <strong>{{ displayGroupName(lesson.academicGroup) }}</strong>
              </div>
            </div>
          </div>
          <div class="col-md-3" *ngIf="lesson.development_group?.length">
            <div class="info-card">
              <i class="fas fa-user-friends text-info"></i>
              <div>
                <small class="text-muted d-block">Colaboradores</small>
                <strong>{{ lesson.development_group.length }}</strong>
              </div>
            </div>
          </div>
          <div class="col-md-3">
            <div class="info-card">
              <i class="fas fa-clock text-warning"></i>
              <div>
                <small class="text-muted d-block">Actualizada</small>
                <strong>{{ lesson.updatedAt | date:'short' }}</strong>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Barra de progreso de la lección -->
    <div class="lesson-progress-bar">
      <div class="progress-header">
        <span class="progress-title">Progreso de la Lección</span>
        <span class="progress-percentage">{{ getProgressPercentage() }}%</span>
      </div>
      <div class="progress-track">
        <div class="progress-fill" [style.width.%]="getProgressPercentage()"></div>
      </div>
      <div class="progress-stages">
        <div *ngFor="let stage of getProgressStages()" 
             class="progress-stage" 
             [class.active]="stage.active"
             [class.completed]="stage.completed">
          <span class="stage-label">{{ stage.label }}</span>
        </div>
      </div>
    </div>

    <!-- Tabs navigation -->
    <ul class="nav nav-tabs lesson-tabs" role="tablist">
      <li class="nav-item" role="presentation">
        <button class="nav-link active" id="info-tab" data-bs-toggle="tab" data-bs-target="#info" type="button" role="tab">
          <i class="fas fa-info-circle me-2"></i>Información
        </button>
      </li>
      <li class="nav-item" role="presentation" *ngIf="canSeePrivateTabs()">
        <button class="nav-link" id="chat-tab" data-bs-toggle="tab" data-bs-target="#chat" type="button" role="tab">
          <i class="fas fa-comments me-2"></i>Conversación
          <span class="badge bg-primary ms-2" *ngIf="lesson.chatMessages?.length">{{ lesson.chatMessages.length }}</span>
        </button>
      </li>
      <li class="nav-item" role="presentation">
        <button class="nav-link" id="files-tab" data-bs-toggle="tab" data-bs-target="#files" type="button" role="tab">
          <i class="fas fa-paperclip me-2"></i>Archivos
          <span class="badge bg-secondary ms-2" *ngIf="lesson.files?.length">{{ lesson.files.length }}</span>
        </button>
      </li>
      <li class="nav-item" role="presentation">
        <button class="nav-link" id="team-tab" data-bs-toggle="tab" data-bs-target="#team" type="button" role="tab">
          <i class="fas fa-user-friends me-2"></i>Equipo
        </button>
      </li>
      <li class="nav-item" role="presentation" *ngIf="canSeePrivateTabs()">
        <button class="nav-link" id="feedback-tab" data-bs-toggle="tab" data-bs-target="#feedback" type="button" role="tab">
          <i class="fas fa-chalkboard-teacher me-2"></i>Retroalimentación
          <span class="badge bg-info ms-2" *ngIf="lesson.comments?.length">{{ lesson.comments.length }}</span>
        </button>
      </li>
    </ul>

    <!-- Tabs content -->
    <div class="tab-content lesson-tab-content">
      <!-- Tab: Información -->
      <div class="tab-pane fade show active" id="info" role="tabpanel">
        <!-- Alerta de requisitos para proponer -->
        <div *ngIf="lesson.status === 'draft'" class="alert alert-warning" role="alert">
          <h6 class="alert-heading"><i class="fas fa-exclamation-triangle me-2"></i>Requisitos para proponer la lección</h6>
          <ul class="mb-0">
            <li *ngIf="!lesson.references || !lesson.references.trim()">
              <strong>Pendiente:</strong> Debes agregar referencias bibliográficas
            </li>
            <li *ngIf="!lesson.files || lesson.files.length === 0">
              <strong>Pendiente:</strong> Debes subir al menos un archivo con recursos
            </li>
            <li *ngIf="lesson.references && lesson.references.trim() && lesson.files && lesson.files.length > 0" class="text-white">
              <i class="fas fa-check-circle me-1"></i>Todos los requisitos cumplidos. Puedes proponer la lección.
            </li>
          </ul>
        </div>

        <div class="row g-4">
          <div class="col-lg-8">
            <!-- Justificación -->
            <div class="content-card">
              <h5 class="card-title"><i class="fas fa-lightbulb me-2"></i>Justificación de la Lección</h5>
              
              <div class="mb-4">
                <h6 class="text-primary"><i class="fas fa-chalkboard-teacher me-2"></i>Metodología</h6>
                <p class="text-muted">{{ lesson.justification?.methodology || 'No especificada' }}</p>
              </div>

              <div>
                <h6 class="text-primary"><i class="fas fa-bullseye me-2"></i>Objetivos de Aprendizaje</h6>
                <p class="text-muted">{{ lesson.justification?.objectives || 'No especificados' }}</p>
              </div>
            </div>

            <!-- Referencias bibliográficas -->
            <div class="content-card">
              <h5 class="card-title"><i class="fas fa-book me-2"></i>Referencias Bibliográficas</h5>
              <div *ngIf="lesson.references && lesson.references.trim(); else noReferences">
                <p class="text-muted" style="white-space: pre-wrap;">{{ lesson.references }}</p>
              </div>
              <ng-template #noReferences>
                <p class="text-muted fst-italic">
                  <i class="fas fa-info-circle me-2"></i>
                  No se han agregado referencias aún. Las referencias son obligatorias antes de proponer la lección.
                </p>
              </ng-template>
            </div>

            <!-- Áreas de conocimiento -->
            <div class="content-card" *ngIf="lesson.knowledge_areas?.length">
              <h5 class="card-title"><i class="fas fa-tags me-2"></i>Áreas de Conocimiento</h5>
              <div class="d-flex flex-wrap gap-2">
                <span *ngFor="let area of lesson.knowledge_areas" class="badge bg-primary">
                  {{ (area?.name || area) }}
                </span>
              </div>
            </div>

            <!-- Tags -->
            <div class="content-card" *ngIf="lesson.tags?.length">
              <h5 class="card-title"><i class="fas fa-hashtag me-2"></i>Etiquetas</h5>
              <div class="d-flex flex-wrap gap-2">
                <span *ngFor="let tag of lesson.tags" class="badge bg-info">
                  #{{ tag }}
                </span>
              </div>
            </div>
          </div>

          <div class="col-lg-4">
            <!-- Configuración académica -->
            <div class="content-card">
              <h5 class="card-title"><i class="fas fa-cog me-2"></i>Configuración</h5>
              <ul class="list-unstyled config-list">
                <li *ngIf="lesson.academicSettings?.subjects?.length">
                  <strong>Materias:</strong>
                  <span class="text-muted">{{ lesson.academicSettings.subjects.join(', ') }}</span>
                </li>
                <li *ngIf="lesson.academicSettings?.academicLevel">
                  <strong>Nivel:</strong>
                  <span class="text-muted">{{ lesson.academicSettings.academicLevel }}</span>
                </li>
                <li>
                  <strong>Creada:</strong>
                  <span class="text-muted">{{ lesson.createdAt | date:'short' }}</span>
                </li>
              </ul>
            </div>
          </div>
        </div>
      </div>

      <!-- Tab: Conversación -->
      <div class="tab-pane fade" id="chat" role="tabpanel" *ngIf="canSeePrivateTabs()">
        <app-lesson-conversations
          [lesson]="lesson"
          [loading]="loading"
          [canEdit]="canEdit()"
          [canChat]="canChat()"
          [(currentConversationId)]="currentConversationId"
          [displayUserName]="displayUserName.bind(this)"
          [userPictureUrl]="userPictureUrl"
          (createConversation)="onCreateConversation($event)"
          (sendMessage)="onSendMessage($event)"
          (typingChange)="onTypingChange($event)"
          (editMessage)="onEditMessage($event)"
          (deleteMessage)="onDeleteMessage($event)">
        </app-lesson-conversations>
      </div>

      <!-- Tab: Archivos -->
      <div class="tab-pane fade" id="files" role="tabpanel">
        <app-lesson-files
          [lesson]="lesson"
          [userRole]="userRole"
          [uploading]="uploading"
          [selectedFile]="selectedFile"
          [resourceDescription]="resourceDescription"
          (resourceDescriptionChange)="resourceDescription = $event"
          (fileSelected)="selectedFile = $event"
          (upload)="uploadResource()"
          (deleteFile)="onDeleteFile($event)"
          (downloadFile)="onDownloadFile($event)">
        </app-lesson-files>
      </div>

      <!-- Tab: Equipo -->
      <div class="tab-pane fade" id="team" role="tabpanel">
        <app-lesson-team
          [lesson]="lesson"
          [loading]="loading"
          [canEdit]="userRole === 'student' && canEdit()"
          [groupStudents]="groupStudents"
          [inviteStudentId]="inviteStudentId"
          (inviteStudentIdChange)="inviteStudentId = $event"
          [inviteMessage]="inviteMessage"
          (inviteMessageChange)="inviteMessage = $event"
          (invite)="inviteCollaborator()">
        </app-lesson-team>
      </div>

      <!-- Tab: Retroalimentación -->
      <div class="tab-pane fade" id="feedback" role="tabpanel" *ngIf="canSeePrivateTabs()">
        <app-lesson-feedback
          [lesson]="lesson"
          [loading]="loading"
          [canAddFeedback]="canAddFeedback()"
          [currentUserId]="currentUserId"
          [teacherFeedback]="teacherFeedback"
          (teacherFeedbackChange)="teacherFeedback = $event"
          [teacherCommentType]="teacherCommentType"
          (teacherCommentTypeChange)="teacherCommentType = $event"
          (addComment)="addTeacherComment()"
          (deleteComment)="onDeleteTeacherComment($event)">
        </app-lesson-feedback>
      </div>
    </div>
  </div>
</div>

<!-- Modal de Aprobación -->
<div class="modal fade show" *ngIf="showApproveModal" style="display: block; background: rgba(0,0,0,0.5);" tabindex="-1">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header bg-success text-white">
        <h5 class="modal-title">
          <i class="fas fa-check-circle me-2"></i>Aprobar Lección
        </h5>
        <button type="button" class="btn-close btn-close-white" (click)="closeApproveModal()"></button>
      </div>
      <div class="modal-body">
        <p class="mb-3">Estás aprobando la lección <strong>"{{ lesson?.title }}"</strong></p>
        
        <div class="mb-3">
          <label for="approveFeedback" class="form-label">
            <strong>Retroalimentación <span class="text-danger">*</span></strong>
          </label>
          <textarea
            id="approveFeedback"
            class="form-control"
            rows="4"
            placeholder="Proporciona comentarios constructivos sobre la lección..."
            name="approveFeedback"
            [(ngModel)]="approveData.feedback"
            [ngModelOptions]="{standalone: true}"
            [disabled]="loading"></textarea>
          <small class="form-text text-muted">
            Estos comentarios serán visibles para el equipo de desarrollo.
          </small>
        </div>

        <div class="alert alert-info mb-0">
          <i class="fas fa-info-circle me-2"></i>
          <strong>Nota:</strong> Al aprobar, la lección cambiará a estado "Aprobada" y el equipo podrá comenzar a desarrollarla.
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" (click)="closeApproveModal()" [disabled]="loading">
          <i class="fas fa-times me-1"></i>Cancelar
        </button>
        <button type="button" class="btn btn-success" (click)="approveLesson()" [disabled]="!approveData.feedback?.trim() || loading">
          <span *ngIf="loading" class="spinner-border spinner-border-sm me-2" role="status"></span>
          <i *ngIf="!loading" class="fas fa-check me-1"></i>
          {{ loading ? 'Aprobando...' : 'Aprobar Lección' }}
        </button>
      </div>
    </div>
  </div>
</div>

<!-- Modal de Rechazo -->
<div class="modal fade show" *ngIf="showRejectModal" style="display: block; background: rgba(0,0,0,0.5);" tabindex="-1">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header bg-danger text-white">
        <h5 class="modal-title">
          <i class="fas fa-times-circle me-2"></i>Rechazar Lección
        </h5>
        <button type="button" class="btn-close btn-close-white" (click)="closeRejectModal()"></button>
      </div>
      <div class="modal-body">
        <p class="mb-3">Estás rechazando la lección <strong>"{{ lesson?.title }}"</strong></p>
        
        <div class="mb-3">
          <label for="rejectReason" class="form-label">
            <strong>Motivo del Rechazo <span class="text-danger">*</span></strong>
          </label>
          <textarea
            id="rejectReason"
            class="form-control"
            rows="4"
            placeholder="Explica por qué la lección no cumple con los requisitos..."
            name="rejectReason"
            [(ngModel)]="rejectReason"
            [ngModelOptions]="{standalone: true}"
            [disabled]="loading"></textarea>
          <small class="form-text text-muted">
            Proporciona retroalimentación clara y constructiva para que puedan mejorar la propuesta.
          </small>
        </div>

        <div class="alert alert-warning mb-0">
          <i class="fas fa-exclamation-triangle me-2"></i>
          <strong>Nota:</strong> Al rechazar, la lección volverá a estado "Borrador" y el equipo podrá editarla y volver a proponerla.
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" (click)="closeRejectModal()" [disabled]="loading">
          <i class="fas fa-arrow-left me-1"></i>Cancelar
        </button>
        <button type="button" class="btn btn-danger" (click)="rejectLesson()" [disabled]="!rejectReason?.trim() || loading">
          <span *ngIf="loading" class="spinner-border spinner-border-sm me-2" role="status"></span>
          <i *ngIf="!loading" class="fas fa-times me-1"></i>
          {{ loading ? 'Rechazando...' : 'Rechazar Lección' }}
        </button>
      </div>
    </div>
  </div>
</div>

<!-- Modal de Calificación extraído a subcomponente -->
<app-lesson-rating
  [show]="showGradeModal"
  [loading]="loading"
  [gradeData]="gradeData"
  (close)="closeGradeModal()"
  (save)="gradeLesson()">
</app-lesson-rating>
