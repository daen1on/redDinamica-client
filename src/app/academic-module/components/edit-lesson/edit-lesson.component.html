<div class="edit-lesson-container">
  <div class="header bg-primary text-white">
    <h2><i class="fas fa-edit me-2"></i>Editar Lección Académica</h2>
    <button class="btn btn-light" (click)="cancel()">
      <i class="fas fa-arrow-left"></i> Volver
    </button>
  </div>

  <!-- Loading -->
  <div *ngIf="loading && !lesson" class="text-center my-5">
    <div class="spinner-border text-primary" role="status">
      <span class="visually-hidden">Cargando...</span>
    </div>
    <p class="mt-2 text-muted">Cargando lección...</p>
  </div>

  <!-- Mensajes de éxito y error -->
  <div *ngIf="successMessage" class="alert alert-success fade show" role="alert">
    <i class="fas fa-check-circle me-2"></i>
    {{ successMessage }}
  </div>

  <div *ngIf="errorMessage" class="alert alert-danger fade show" role="alert">
    <i class="fas fa-times-circle me-2"></i>
    {{ errorMessage }}
  </div>

  <!-- Información del estado -->
  <div *ngIf="lesson && !loading" class="alert alert-info mb-4">
    <i class="fas fa-info-circle me-2"></i>
    <strong>Estado actual:</strong> {{ getStatusLabel(lesson.status || 'draft') }}
    <p class="mb-1 mt-2" *ngIf="lesson.status === 'draft'">
      Completa toda la información y agrega referencias para poder proponer la lección al docente.
    </p>
    <p class="mb-1 mt-2" *ngIf="lesson.status === 'in_development'">
      La lección está en desarrollo. Cuando termines, márcala como completada para que el docente la califique.
    </p>
    <p class="mb-0 mt-2" *ngIf="lesson.status === 'completed' || lesson.status === 'graded'">
      Esta lección ya está {{lesson.status === 'completed' ? 'completada' : 'calificada'}} y no puede ser editada.
    </p>
  </div>

  <!-- Formulario principal -->
  <div *ngIf="lesson && !loading" class="form-container">
    <form [formGroup]="lessonForm" (ngSubmit)="onSubmit()" class="lesson-form">
      
      <!-- Campos básicos -->
      <div class="row">
        <div class="col-md-12">
          <!-- Título de la lección -->
          <div class="mb-3">
            <label for="title" class="form-label">
              <strong>Título de la Lección<span class="text-danger">*</span></strong>
            </label>
            <input 
              type="text" 
              id="title"
              formControlName="title"
              class="form-control"
              [class.is-invalid]="isFieldInvalid('title')"
              placeholder="Ingresa el título de la lección"
              autocomplete="off">
            <div *ngIf="isFieldInvalid('title')" class="invalid-feedback">
              {{ getErrorMessage('title') }}
            </div>
          </div>

          <!-- Resumen -->
          <div class="mb-3">
            <label for="resume" class="form-label">
              <strong>Resumen<span class="text-danger">*</span></strong>
            </label>
            <textarea 
              id="resume"
              formControlName="resume"
              class="form-control"
              [class.is-invalid]="isFieldInvalid('resume')"
              rows="3"
              placeholder="Describe brevemente el contenido y objetivos de la lección..."></textarea>
            <div *ngIf="isFieldInvalid('resume')" class="invalid-feedback">
              {{ getErrorMessage('resume') }}
            </div>
          </div>
        </div>
      </div>

      <!-- Áreas de Conocimiento con Autocompletado -->
      <div class="row">
        <div class="col-md-6">
          <div class="mb-3">
            <label class="form-label">
              <strong>Áreas de Conocimiento<span class="text-danger">*</span></strong>
            </label>
            
            <!-- Chips de áreas seleccionadas -->
            <div class="selected-items-container mb-2" *ngIf="selectedKnowledgeAreas.length > 0">
              <span *ngFor="let area of selectedKnowledgeAreas" 
                    class="badge bg-primary me-1 mb-1 selected-chip">
                {{area.name}}
                <button type="button" 
                        class="btn-close btn-close-white ms-1" 
                        (click)="removeKnowledgeArea(area)"
                        aria-label="Eliminar">
                </button>
              </span>
            </div>

            <!-- Input de autocompletado -->
            <div class="knowledge-area-autocomplete position-relative">
              <input type="text" 
                     class="form-control" 
                     [(ngModel)]="knowledgeAreaInput"
                     [ngModelOptions]="{standalone: true}"
                     (input)="onKnowledgeAreaInputChange()"
                     (keyup.enter)="addNewKnowledgeAreaFromInput()"
                     [ngClass]="{'is-invalid': submitted && f['knowledge_area'].errors}"
                     placeholder="Escribe para buscar o agregar área de conocimiento..."
                     autocomplete="off">
              
              <!-- Dropdown de sugerencias -->
              <div *ngIf="showKnowledgeAreaDropdown" 
                   class="dropdown-menu show position-absolute w-100 mt-1" 
                   style="z-index: 1050; max-height: 200px; overflow-y: auto;">
                
                <!-- Áreas existentes -->
                <button *ngFor="let area of filteredKnowledgeAreas" 
                        type="button"
                        class="dropdown-item" 
                        (click)="selectKnowledgeArea(area)">
                  <i class="fas fa-tag me-2"></i>
                  {{area.name}}
                </button>
                
                <!-- Opción para crear nueva área -->
                <div *ngIf="knowledgeAreaInput.trim() && filteredKnowledgeAreas.length === 0" 
                     class="dropdown-divider"></div>
                <button *ngIf="knowledgeAreaInput.trim() && filteredKnowledgeAreas.length === 0" 
                        type="button"
                        class="dropdown-item text-success" 
                        (click)="addNewKnowledgeAreaFromInput()">
                  <i class="fas fa-plus me-2"></i>
                  Crear "{{knowledgeAreaInput}}"
                </button>
              </div>
            </div>

            <small class="form-text text-muted">
              Escribe para buscar áreas existentes o crear nuevas
            </small>

            <div *ngIf="submitted && f['knowledge_area'].errors" class="invalid-feedback d-block">
              <div *ngIf="f['knowledge_area'].errors['required']">
                Debes seleccionar al menos un área de conocimiento.
              </div>
            </div>
          </div>
        </div>

        <!-- Etiquetas -->
        <div class="col-md-6">
          <div class="mb-3">
            <label for="tags" class="form-label">
              <strong>Etiquetas <small class="text-muted">(Opcional)</small></strong>
            </label>
            <input 
              type="text" 
              id="tags"
              formControlName="tags"
              class="form-control"
              [class.is-invalid]="isFieldInvalid('tags')"
              placeholder="Ej: dinámica de sistemas, modelado, simulación"
              autocomplete="off">
            <div *ngIf="isFieldInvalid('tags')" class="invalid-feedback">
              {{ getErrorMessage('tags') }}
            </div>
            <small class="form-text text-muted">
              Separa las etiquetas con comas
            </small>
          </div>
        </div>
      </div>

      <!-- Metodología -->
      <div class="mb-3">
        <label for="methodology" class="form-label">
          <strong>Metodología<span class="text-danger">*</span></strong>
        </label>
        <textarea 
          id="methodology"
          formControlName="methodology"
          class="form-control"
          [class.is-invalid]="isFieldInvalid('methodology')"
          rows="4"
          placeholder="¿Cómo se desarrollará la lección? Justifica el modelo de dinámica de sistemas que se llevará a cabo y las actividades principales..."></textarea>
        <div *ngIf="isFieldInvalid('methodology')" class="invalid-feedback">
          {{ getErrorMessage('methodology') }}
        </div>
      </div>

      <!-- Objetivos de aprendizaje -->
      <div class="mb-3">
        <label for="objectives" class="form-label">
          <strong>Objetivos de Aprendizaje<span class="text-danger">*</span></strong>
        </label>
        <textarea 
          id="objectives"
          formControlName="objectives"
          class="form-control"
          [class.is-invalid]="isFieldInvalid('objectives')"
          rows="3"
          placeholder="¿Qué se espera lograr con esta lección? Define las competencias y conocimientos que se adquirirán..."></textarea>
        <div *ngIf="isFieldInvalid('objectives')" class="invalid-feedback">
          {{ getErrorMessage('objectives') }}
        </div>
      </div>

      <!-- Referencias / Citas -->
      <div class="mb-3">
        <label for="references" class="form-label">
          <strong>Referencias <small class="text-muted">(Requeridas al proponer)</small></strong>
        </label>
        <textarea
          id="references"
          formControlName="references"
          class="form-control"
          rows="4"
          placeholder="Incluye las citas o enlaces de las fuentes utilizadas (APA/IEEE u otras). Requeridas para proponer la lección."></textarea>
        <small class="form-text text-muted">Máximo 2000 caracteres. Acepta texto libre y URLs.</small>
      </div>

      <!-- Cambio de Estado: antes de aprobación (borrador/propuesta) y después (completada) -->
      <div class="mb-3">
        <label for="status" class="form-label">
          <strong>Cambiar Estado</strong>
        </label>

        <!-- Fase previa (borrador/propuesta) -->
        <ng-container *ngIf="lesson?.status === 'draft' || lesson?.status === 'proposed'; else afterApproval">
          <select id="status" formControlName="status" class="form-select">
            <option value="draft">Borrador</option>
            <option value="proposed">Propuesta</option>
          </select>
          <small class="form-text text-muted">
            Al proponer, el docente recibirá una notificación para revisar tu lección.
          </small>
        </ng-container>

        <!-- Fase posterior (en desarrollo -> solo permitir marcar como completada) -->
        <ng-template #afterApproval>
          <ng-container *ngIf="lesson?.status === 'in_development'">
            <select id="status" formControlName="status" class="form-select">
              <option value="completed">Completada</option>
            </select>
            <small class="form-text text-muted">
              <strong class="text-warning">⚠️ Para completar la lección, asegúrate de tener al menos un archivo con el modelo desarrollado.</strong>
            </small>
          </ng-container>
        </ng-template>
      </div>

      <!-- Información de archivos -->
      <div *ngIf="lesson.files && lesson.files.length > 0" class="alert alert-success">
        <i class="fas fa-check-circle me-2"></i>
        <strong>Archivos cargados:</strong> {{ lesson.files.length }} archivo(s)
      </div>

      <div *ngIf="!lesson.files || lesson.files.length === 0" class="alert alert-warning">
        <i class="fas fa-exclamation-triangle me-2"></i>
        <strong>Sin archivos:</strong> Recuerda subir archivos desde el detalle de la lección (pestaña Archivos) antes de completar.
      </div>

      <!-- Botones de acción -->
      <div class="form-actions mt-4">
        <button 
          type="button" 
          class="btn btn-secondary" 
          (click)="cancel()"
          [disabled]="loading">
          <i class="fas fa-times me-1"></i>
          Cancelar
        </button>
        <button 
          type="submit" 
          class="btn btn-success"
          [disabled]="loading || lessonForm.invalid">
          <span *ngIf="loading" class="spinner-border spinner-border-sm me-2" role="status"></span>
          <i *ngIf="!loading" class="fas fa-save me-1"></i>
          {{ loading ? 'Guardando...' : 'Guardar Cambios' }}
        </button>
      </div>
    </form>
  </div>

  <!-- Información adicional -->
  <div class="info-section" *ngIf="lesson">
    <div class="info-card">
      <h4><i class="fas fa-info-circle"></i> Información Importante</h4>
      <ul>
        <li><strong>Para proponer:</strong> Necesitas referencias y al menos un archivo</li>
        <li><strong>Para completar:</strong> Debes tener al menos un archivo con el modelo desarrollado</li>
        <li><strong>Archivos:</strong> Se gestionan desde el detalle de la lección (pestaña Archivos)</li>
        <li><strong>Colaboradores:</strong> Se invitan desde el detalle de la lección (pestaña Equipo)</li>
      </ul>
    </div>
  </div>
</div>

<!-- Estilos CSS adicionales -->
<style>
.selected-chip {
    font-size: 0.875rem;
    padding: 0.375rem 0.5rem;
    display: inline-flex;
    align-items: center;
}

.selected-chip .btn-close {
    font-size: 0.7rem;
    width: 0.8rem;
    height: 0.8rem;
}

.selected-items-container {
    min-height: 2rem;
    padding: 0.375rem;
    border: 1px solid #dee2e6;
    border-radius: 0.375rem;
    background-color: #f8f9fa;
}

.dropdown-menu.show {
    display: block;
    border: 1px solid #dee2e6;
    box-shadow: 0 0.125rem 0.25rem rgba(0, 0, 0, 0.075);
}

.dropdown-item:hover {
    background-color: #e9ecef;
}

.knowledge-area-autocomplete .dropdown-menu {
    top: 100% !important;
    left: 0 !important;
    right: 0 !important;
}
</style>

