<span id="top"></span>

<div *ngIf="!identity.actived" class="bg-white py-5 mb-2 px-4 rounded border">
    <h2 class="">Bienvenido a
        <strong class="display-4 text-primary fw-bolder rd">
            RedDinámica
        </strong>
    </h2>
    <hr class="my-2 text-primary" style="border: 3px solid">
    <h2>
    <p class="text-muted" style="margin-top: 25px; text-emphasis-color: red;">

        Recuerda que para poder ver la sección de recursos y lecciones del sitio debes esperar a que
        el administrador revise tu registro.
    
        También deberás volver a iniciar sesión una vez se haya activado tu cuenta.
    </p>
    </h2>
</div>

<div id="new-post" class="card mb-2">
    <form [formGroup]="postForm" (ngSubmit)="onSubmit()" enctype="multipart/form-data">
        <div class="card-header">
            <label class="card-title m-0" style="font-size: 1.5em" for="textPost">
                <strong>Crear publicación: </strong>
            </label>
        </div>
        <div class="card-body">
            <div class="row mb-0 justify-content-center">
                <div class="col-2 align-items-center">
                    <a class="nav-link d-flex">
                        <div class=" flex-shrink-0 rounded-circle border-1 overflow-hidden me-2"
                            style="width: 55px; height:55px;">
                            <img *ngIf="!identity.picture" class="img-fluid" src="assets/images/user-default.png">
                            <img *ngIf="identity.picture" class="img-fluid"
                                src="{{this.url+'get-image-user/'+ identity.picture}}">
                        </div>
                    </a>
                </div>
                <div class="col-10 ps-0">
                    <textarea class="bg-light text-justify" formControlName="textPost" class="form-control" id="textPost" rows="3"
                        (input)="onChanges()"
                        [ngClass]="{ 'is-invalid': submitted && (formError || typeError || maxSizeError)}"></textarea>
                    <div class="progress" *ngIf="(filesToUpload != null || barWidth!='0%')">
                            <div #progress  class="progress-bar progress-bar-striped progress-bar-animated" role="progressbar" [style.width]="barWidth"
                             aria-valuenow="barWidth" aria-valuemin="0" aria-valuemax="100">{{barWidth}}</div>
                    </div>
                    <div *ngIf="submitted && (formError || typeError || maxSizeError)" class="invalid-feedback">
                        <div *ngIf="formError">
                            Es necesario escribir algo o cargar una imagen para poder crear la publicación.
                        </div>
                        <div *ngIf="typeError">
                            Archivo inválido, solo se permite cargar imágenes con extensión jpg, png o gif.
                        </div>
                        <div *ngIf="maxSizeError">
                            El archivo es demasiado grande, el tamaño maximo permitido es de
                            {{MAX_FILE_SIZE}}MB.
                        </div>
                    </div>

                    <small *ngIf="filesToUpload.length > 0" class="text-muted">
                        <i class="fas fa-paperclip"></i>
                        {{filesToUpload[0].name}}
                    </small>
                </div>

            </div>
            <div class="text-end py-1 px-0 bg-transparent">
                <div class="row mb-0 d-flex align-items-center">
                    <div class="col-9">
                        <div *ngIf="status === 'error'; successMessage"
                            class="alert alert-danger fade show text-center m-0" role="alert">
                            <i class="fas fa-times-circle icon-message me-2"></i>
                            Hubo un error creando la publicación. Intentalo de nuevo.
                        </div>
                        <div *ngIf="status === 'warning'; successMessage"
                        class="alert alert-warning fade show text-center m-0" role="alert">
                        <i class="fas fa-check-circle icon-message me-2"></i>
                        La publicación se esta subiendo, por favor evita cerrar.
                    </div>
                        <div *ngIf="status === 'success'; successMessage"
                            class="alert alert-success fade show text-center m-0" role="alert">
                            <i class="fas fa-check-circle icon-message me-2"></i>
                            La publicación se ha creado correctamente.
                        </div>

                    </div>
                    <div class="col-1 bg-transparent">
                        <label class="m-0" style="font-size: 2.2em" title="Cargar imagen" for="filePost">
                            <i class="fas fa-image text-success" style="cursor:pointer"></i>
                            <input formControlName="filePost" style="display:none" type="file" id="filePost" class="form-control"
                                   name="image" (change)="fileChangeEvent($event)" (click)="setUpload()">
                        </label>
                        

                    </div>
                    <div class="col bg-transparent">
                        <button type="submit" class="btn btn-success w-100" [disabled]="submitted">Publicar</button>
                    </div>
                </div>
            </div>

        </div>
    </form>
</div>

<div *ngIf="publications.length == 0 && !loading" class="card-body">
    <h4 class="text-muted">
        No hay publicaciones que mostrar. Comparte lo que quieras con los miembros de RedDinámica.
        <i class="fas fa-laugh icon-message"></i>
    </h4>
</div>

<div *ngIf="loading" class="card-body">
    <div class="text-muted text-center">
        <div class="spinner-border" style="width: 3rem; height: 3rem;" role="status">
            <span class="visually-hidden">Loading...</span>
        </div>
    </div>
</div>

<!-- Lista de publicaciones usando el nuevo componente -->
<div *ngFor="let publication of publications" 
     [id]="'publication-' + publication._id"
     [attr.data-publication-id]="publication._id"
     class="publication-card">
    <app-publication-card 
        [publication]="publication"
        [identity]="identity"
        [showDeleteButton]="true"
        (onDelete)="setDelete($event)"
        (onDeleteComment)="setDeleteComment($event)"
        (onError)="setErrorMessage($event)">
    </app-publication-card>
</div>

<div *ngIf="publications && publications.length > 0" class="text-center">
    <button *ngIf="!noMore" class="btn btn-primary" (click)="viewMore()">Ver más publicaciones</button>
    <div *ngIf="noMore && publications.length > 0" class="text-muted mt-3">
        <i class="fas fa-check-circle me-2"></i>
        Has visto todas las publicaciones disponibles
    </div>
</div>

<!-- Modal warning delete -->
<div class="modal fade" id="delete" tabindex="-1" role="dialog" aria-labelledby="deletePublicationTitle" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered" role="document">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="deleteTitle">Eliminar publicación</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <div class="alert alert-warning mb-0" role="alert">
            <i class="fas fa-exclamation-triangle icon-message me-2"></i>
            ¿Está seguro que desea eliminar la publicación?
          </div>
        </div>
        <div class="modal-footer">
          <button class="btn btn-danger" (click)="deletePost()" data-bs-dismiss="modal">Sí</button>
          <button class="btn btn-secondary" data-bs-dismiss="modal">No</button>
        </div>
      </div>
    </div>
  </div>
  <!-- /Modal warning delete -->
  
<!-- Modal warning delete comment -->
<div class="modal fade" id="deleteComment" tabindex="-1" role="dialog" aria-labelledby="deleteCommentTitle" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered" role="document">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="deleteCommentTitle">Eliminar comentario</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <div class="alert alert-warning mb-0" role="alert">
            <i class="fas fa-exclamation-triangle icon-message me-2"></i>
            ¿Está seguro que desea eliminar el comentario?
          </div>
        </div>
        <div class="modal-footer">
          <button class="btn btn-danger" data-bs-dismiss="modal" (click)="deleteComment()">Sí</button>
          <button class="btn btn-secondary" data-bs-dismiss="modal">No</button>
        </div>
      </div>
    </div>
  </div>
  <!-- /Modal warning delete comment -->