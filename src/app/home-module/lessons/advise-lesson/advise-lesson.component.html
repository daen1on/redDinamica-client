<!-- my lessons -->
<div class="card">
    <div class="card-header">
        <h3 class="m-0 text-primary font-weight-bolder float-left">{{title}}</h3>
    </div>

    <div *ngIf="loading" class="card-body">
        <div class="text-muted text-center">
            <div class="spinner-border" style="width: 3rem; height: 3rem;" role="status">
                <span class="sr-only">Loading...</span>
            </div>
        </div>
    </div>

    <div *ngIf="lessons.length == 0 && !loading" class="card-body">
        <h4 class="text-muted">
            No tienes ninguna lección asignada para asesorar.
        </h4>
    </div>

    <div *ngIf="lessons.length != 0" class="card-body">

        <!-- checkbox filter -->
        <div class="row">
            <div class="col">
                <div class="form-group">
                    <div class="row">
                        <div *ngFor="let state of states" class="col">
                            <div class="custom-control custom-checkbox">
                                <input type="checkbox" class="custom-control-input" id="{{state.value}}"
                                    (click)="setState(state.value)">
                                <label class="custom-control-label" for="{{state.value}}">
                                    {{state.label}}
                                </label>
                            </div>
                        </div>
                    </div>
                </div>


            </div>

        </div>
        <!-- /checkbox filter -->

        <!-- lesson items -->
        <div *ngIf="selectedStates.length == 0">
            <div *ngFor="let lesson of lessons, let i=index">
                <div class="card mb-2">
                    <div class="card-body">
                        <div class="media-body">
                            <div class="row">
                                <div class="col-auto">
                                    <div class="row">
                                        <div class="col">
                                            <div class="text-center p-2 py-3 rounded-lg border border-ligth text-center bg-{{lesson_states[lesson.state].class}}"
                                                [routerLink]="['/inicio','leccion', lesson._id]"
                                                style="width: 100%; height: 80px; overflow: hidden; cursor: pointer;">
                                                <i class="text-white fas fa-chalkboard-teacher"
                                                    style="font-size:50px"></i>

                                            </div>
                                        </div>

                                    </div>

                                    <div class="row mt-1">

                                        <div class="col-12">
                                            <button class="btn w-100 btn-sm" disabled title="Versión">
                                                <span>V. {{lesson.version.toFixed(1)}}</span>
                                            </button>
                                            <button *ngIf="lesson.state == 'completed'" class="btn w-100 btn-sm"
                                                disabled title="Calificación">
                                                <i class="fas fa-star"></i> {{lesson.score.toFixed(2)}}
                                            </button>
                                            <button *ngIf="lesson.state == 'completed'" class="btn w-100 btn-sm"
                                                disabled title="Visualizaciones">
                                                <span>
                                                    <i class="fas fa-eye"></i>
                                                    <span> {{lesson.views}}</span>
                                                </span>
                                            </button>
                                        </div>
                                    </div>

                                </div>
                                <div class="col">
                                    <div class="row">
                                        <div class="col">
                                            <div style="cursor: pointer;" [routerLink]="['/inicio','leccion', lesson._id]">
                                                <h5 class="my-0"> 
                                                    <strong>{{lesson.title}}</strong>
                                                </h5>
                                            </div>
                                            
                                            <small class=" text-muted">
                                                {{ (lesson.created_at | amFromUnix) | amLocale:'es' | amDateFormat:'LL' }}
                                            </small>
                                            <h5>
                                                <span class="badge badge-{{lesson_states[lesson.state].class}} me-1">
                                                    {{lesson_states[lesson.state].label}}
                                                </span>
                                            </h5>
                                            <p *ngFor="let text of lesson.resume.split('\n'); let i = index"
                                                class="text-justify">
                                                <small *ngIf="i==0">{{text}}...</small>
                                            </p>

                                        </div>

                                        <div class="text-end col-auto">

                                            <!-- buttons -->
                                            <button class="btn btn-info ms-2"
                                                (click)="handleViewLesson(lesson)" 
                                                title="Ver lección">
                                                <i class="fas fa-eye"></i>
                                            </button>
                                            
                                            <!-- Botón de aprobación - solo visible para facilitador sugerido en estado 'proposed' -->
                                            <button *ngIf="isSuggestedFacilitator(lesson) && isProposedLesson(lesson)"
                                                class="btn btn-success ms-2" 
                                                (click)="approveLesson(lesson)"
                                                title="Avalar Lección ">
                                                <i class="fas fa-check-circle me-1"></i>
                                                Avalar Convocatoria
                                            </button>
                                            <!-- /buttons -->

                                        </div>

                                    </div>


                                    <div class="row">
                                        <div class="col-6">
                                            <div class="row">
                                                <div class="col">
                                                    <strong>Nivel académico:</strong>
                                                </div>
                                            </div>
                                            <div class="row">
                                                <div class="col">
                                                    <p>
                                                        <span
                                                            *ngIf="academic_level.hasOwnProperty(lesson.level); else notAssigned">
                                                            {{academic_level[lesson.level]}}
                                                        </span>
                                                        <ng-template #notAssigned>
                                                            <small class="text-muted">No se ha asignado</small>
                                                        </ng-template>
                                                    </p>
                                                </div>

                                            </div>


                                        </div>


                                        <div class="col-6">
                                            <div class="row">
                                                <div class="col">
                                                    <strong>Áreas de conocimiento:</strong>
                                                </div>
                                            </div>

                                            <div class="row">
                                                <div class="col">
                                                    <div *ngIf="lesson.knowledge_area.length > 0; else notAssigned"
                                                        style="display: flex; flex-wrap: wrap;">
                                                        <small *ngFor="let area of lesson.knowledge_area"
                                                            class="badge badge-info me-1 mb-1 text-truncate"
                                                            title="{{area.name}}">{{area.name}}</small>
                                                    </div>
                                                    <ng-template #notAssigned>
                                                        <small class="text-muted">No se ha asignado</small>
                                                    </ng-template>

                                                </div>

                                            </div>


                                        </div>


                                    </div>

                                </div>


                            </div>




                        </div>
                    </div>
                </div>
            </div>
        </div>
        <!-- /lesson items -->

        <!-- lesson items filtered -->
        <div *ngIf="selectedStates.length > 0">
            <div *ngFor="let lesson of allLessons, let i=index">
                <div class="card mb-2">
                    <div class="card-body">
                        <div class="media-body">
                            <div class="row">
                                <div class="col-auto">
                                    <div class="row">
                                        <div class="col">
                                            <div class="text-center p-2 py-3 rounded-lg border border-ligth text-center bg-{{lesson_states[lesson.state].class}}"
                                                [routerLink]="['/inicio','leccion', lesson._id]"
                                                style="width: 100%; height: 80px; overflow: hidden;cursor: pointer;">
                                                <i class="text-white fas fa-chalkboard-teacher"
                                                    style="font-size:50px"></i>

                                            </div>
                                        </div>

                                    </div>

                                    <div class="row mt-1">

                                        <div class="col-12">
                                            <button class="btn w-100 btn-sm" disabled title="Versión">
                                                <span>V. {{lesson.version.toFixed(1)}}</span>
                                            </button>
                                            <button *ngIf="lesson.state == 'completed'" class="btn w-100 btn-sm"
                                                disabled title="Calificación">
                                                <i class="fas fa-star"></i> {{lesson.score.toFixed(2)}}
                                            </button>
                                            <button *ngIf="lesson.state == 'completed'" class="btn w-100 btn-sm"
                                                disabled title="Visualizaciones">
                                                <span>
                                                    <i class="fas fa-eye"></i>
                                                    <span> {{lesson.views}}</span>
                                                </span>
                                            </button>
                                        </div>
                                    </div>

                                </div>
                                <div class="col">
                                    <div class="row">
                                        <div class="col">
                                            <div [routerLink]="['/inicio','leccion', lesson._id]" style="cursor: pointer;">
                                                <h5 class="my-0">
                                                    <strong>{{lesson.title}}</strong>
                                                </h5>
                                            </div>
                                            <small class=" text-muted">
                                                {{ (lesson.created_at | amFromUnix) | amLocale:'es' | amDateFormat:'LL' }}
                                            </small>
                                            <h5>
                                                <span class="badge badge-{{lesson_states[lesson.state].class}} me-1">
                                                    {{lesson_states[lesson.state].label}}
                                                </span>
                                            </h5>

                                            <p *ngFor="let text of lesson.resume.split('\n'); let i = index"
                                                class="text-justify">
                                                <small *ngIf="i==0">{{text}}...</small>
                                            </p>

                                        </div>

                                        <div class="text-end col-auto">

                                            <!-- buttons -->
                                            <button class="btn btn-info ms-2"
                                                (click)="handleViewLesson(lesson)" 
                                                title="Ver lección">
                                                <i class="fas fa-eye"></i>
                                            </button>
                                            
                                            <!-- Botón de aprobación - solo visible para facilitador sugerido en estado 'proposed' -->
                                            <button *ngIf="isSuggestedFacilitator(lesson) && isProposedLesson(lesson)"
                                                class="btn btn-success ms-2" 
                                                (click)="approveLesson(lesson)"
                                                title="Avalar lección">
                                                <i class="fas fa-check-circle me-1"></i>
                                                Avalar Convocatoria
                                            </button>
                                            <!-- /buttons -->

                                        </div>

                                    </div>


                                    <div class="row">
                                        <div class="col-6">
                                            <div class="row">
                                                <div class="col">
                                                    <strong>Nivel académico:</strong>
                                                </div>
                                            </div>
                                            <div class="row">
                                                <div class="col">
                                                    <p>
                                                        <span
                                                            *ngIf="academic_level.hasOwnProperty(lesson.level); else notAssigned">
                                                            {{academic_level[lesson.level]}}
                                                        </span>
                                                        <ng-template #notAssigned>
                                                            <small class="text-muted">No se ha asignado</small>
                                                        </ng-template>
                                                    </p>
                                                </div>

                                            </div>


                                        </div>


                                        <div class="col-6">
                                            <div class="row">
                                                <div class="col">
                                                    <strong>Áreas de conocimiento:</strong>
                                                </div>
                                            </div>

                                            <div class="row">
                                                <div class="col">

                                                    <div *ngIf="lesson.knowledge_area.length > 0; else notAssigned"
                                                        style="display: flex; flex-wrap: wrap;">
                                                        <small *ngFor="let area of lesson.knowledge_area"
                                                            class="badge badge-info me-1 mb-1 text-truncate"
                                                            title="{{area.name}}">{{area.name}}</small>
                                                    </div>
                                                    <ng-template #notAssigned>
                                                        <small class="text-muted">No se ha asignado</small>
                                                    </ng-template>

                                                </div>

                                            </div>


                                        </div>


                                    </div>

                                </div>


                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <!-- /lesson items filtered -->

        <!-- Navigation -->
        <nav *ngIf="selectedStates.length == 0" class="mt-3" aria-label="Page navigation">
            <ul class="pagination justify-content-end">
                <li *ngIf="page > 1" class="page-item">
                    <a class="page-link bg-primary" [routerLink]="['/inicio/mis-lecciones', prevPage]">Anterior</a>
                </li>
                <li *ngIf="page < pages && page != pages" class="page-item">
                    <a class="page-link bg-info" [routerLink]="['/inicio/mis-lecciones', nextPage]">Siguiente</a>
                </li>
            </ul>
        </nav>
        <!-- /Navigation -->
    </div>
    <div *ngIf="lessons.length > 0 && allLessons.length == 0 && !loading" class="card-body">
        <div class="card-body">
            <h4 class="text-muted">
                No se encontraron lecciones para los criterios de búsqueda seleccionados.
            </h4>
        </div>
    </div>

</div>
<!-- /my lessons -->

<!-- Modal de Previsualización de Lección -->
<div class="modal fade" [class.show]="showPreviewModal" [style.display]="showPreviewModal ? 'block' : 'none'" 
     id="previewLessonModal" tabindex="-1" role="dialog" aria-labelledby="previewLessonModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-xl" role="document">
        <div class="modal-content" *ngIf="selectedLessonForPreview">
            <div class="modal-header bg-primary text-white">
                <h5 class="modal-title" id="previewLessonModalLabel">
                    <i class="fas fa-eye me-2"></i>
                    Previsualización de Lección Propuesta
                </h5>
                <button type="button" class="btn-close btn-close-white" (click)="closePreviewModal()" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <!-- Información del autor -->
                <div class="row mb-4">
                    <div class="col-12">
                        <div class="alert alert-info">
                            <div class="d-flex align-items-center">
                                <img *ngIf="selectedLessonForPreview.author?.picture" 
                                     [src]="url + 'get-file-user/' + selectedLessonForPreview.author.picture" 
                                     class="rounded-circle me-3" width="50" height="50" alt="Autor">
                                <div>
                                    <h6 class="mb-1">
                                        <strong>Propuesta enviada por:</strong> 
                                        {{selectedLessonForPreview.author?.name}} {{selectedLessonForPreview.author?.surname}}
                                    </h6>
                                    <small class="text-muted">
                                        <i class="fas fa-calendar me-1"></i>
                                        {{ (selectedLessonForPreview.created_at | amFromUnix) | amLocale:'es' | amDateFormat:'LL' }}
                                    </small>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Detalles de la lección -->
                <div class="row">
                    <div class="col-12">
                        <div class="card">
                            <div class="card-header">
                                <h5 class="mb-0">
                                    <i class="fas fa-info-circle me-2"></i>
                                    Detalles de la Lección
                                </h5>
                            </div>
                            <div class="card-body">
                                <div class="row mb-3">
                                    <div class="col-md-6">
                                        <strong>Título:</strong>
                                        <p class="mt-1">{{selectedLessonForPreview.title}}</p>
                                    </div>
                                    <div class="col-md-6">
                                        <strong>Estado:</strong>
                                        <p class="mt-1">
                                            <span class="badge bg-secondary">
                                                {{lesson_states[selectedLessonForPreview.state]?.label || 'Propuesta'}}
                                            </span>
                                        </p>
                                    </div>
                                </div>

                                <div class="row mb-3">
                                    <div class="col-md-6">
                                        <strong>Niveles Académicos:</strong>
                                        <div class="mt-1" *ngIf="selectedLessonForPreview.level && selectedLessonForPreview.level.length > 0; else noLevels">
                                            <span *ngFor="let level of selectedLessonForPreview.level" 
                                                  class="badge bg-info me-1 mb-1">
                                                {{academic_level[level] || level}}
                                            </span>
                                        </div>
                                        <ng-template #noLevels>
                                            <p class="text-muted mt-1">No especificado</p>
                                        </ng-template>
                                    </div>
                                    <div class="col-md-6">
                                        <strong>Áreas de Conocimiento:</strong>
                                        <div class="mt-1" *ngIf="selectedLessonForPreview.knowledge_area && selectedLessonForPreview.knowledge_area.length > 0; else noAreas">
                                            <span *ngFor="let area of selectedLessonForPreview.knowledge_area" 
                                                  class="badge bg-success me-1 mb-1">
                                                {{area.name || area}}
                                            </span>
                                        </div>
                                        <ng-template #noAreas>
                                            <p class="text-muted mt-1">No especificado</p>
                                        </ng-template>
                                    </div>
                                </div>

                                <div class="row mb-3">
                                    <div class="col-12">
                                        <strong>Resumen:</strong>
                                        <p class="mt-1" style="white-space: pre-line;">{{selectedLessonForPreview.resume}}</p>
                                    </div>
                                </div>

                                <div class="row mb-3">
                                    <div class="col-12">
                                        <strong>Referencias:</strong>
                                        <p class="mt-1" style="white-space: pre-line;">{{selectedLessonForPreview.references}}</p>
                                    </div>
                                </div>

                                <div class="row mb-3" *ngIf="selectedLessonForPreview.justification">
                                    <div class="col-12">
                                        <strong>Justificación:</strong>
                                        <p class="mt-1" style="white-space: pre-line;">{{selectedLessonForPreview.justification}}</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <!-- Botones solo visibles para facilitador sugerido -->
                <div *ngIf="isSuggestedFacilitator(selectedLessonForPreview) && isProposedLesson(selectedLessonForPreview)" 
                     class="w-100 d-flex justify-content-between">
                    <div>
                        <button type="button" class="btn btn-danger me-2" (click)="rejectLessonSuggestion(selectedLessonForPreview)">
                            <i class="fas fa-times me-1"></i>
                            Rechazar Lección
                        </button>
                        <button type="button" class="btn btn-success" (click)="approveLesson(selectedLessonForPreview)">
                            <i class="fas fa-check-circle me-1"></i>
                            Avalar Convocatoria
                        </button>
                    </div>
                    <button type="button" class="btn btn-secondary" (click)="closePreviewModal()">
                        Cerrar
                    </button>
                </div>
                
                <!-- Botón solo de cerrar para otros usuarios -->
                <div *ngIf="!isSuggestedFacilitator(selectedLessonForPreview) || !isProposedLesson(selectedLessonForPreview)" 
                     class="w-100 d-flex justify-content-end">
                    <button type="button" class="btn btn-secondary" (click)="closePreviewModal()">
                        Cerrar
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Overlay del modal -->
<div class="modal-backdrop fade" [class.show]="showPreviewModal" *ngIf="showPreviewModal" (click)="closePreviewModal()"></div>