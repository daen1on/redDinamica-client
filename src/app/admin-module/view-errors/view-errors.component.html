<div class="container">
  <h2>Gestión de Reportes y Denuncias</h2>
  
  <!-- Pestañas de navegación -->
  <ul class="nav nav-tabs mb-3" id="reportsTabs" role="tablist">
    <li class="nav-item" role="presentation">
      <button class="nav-link active" id="technical-tab" data-bs-toggle="tab" data-bs-target="#technical" type="button" role="tab" aria-controls="technical" aria-selected="true">
        Errores y Sugerencias
      </button>
    </li>
    <li class="nav-item" role="presentation">
      <button class="nav-link" id="complaints-tab" data-bs-toggle="tab" data-bs-target="#complaints" type="button" role="tab" aria-controls="complaints" aria-selected="false">
        Denuncias
      </button>
    </li>
  </ul>

  <!-- Contenido de las pestañas -->
  <div class="tab-content" id="reportsTabsContent">
    
    <!-- Pestaña de Errores y Sugerencias -->
    <div class="tab-pane fade show active" id="technical" role="tabpanel" aria-labelledby="technical-tab">
      <div class="mb-3">
        <div class="accordion" id="filterAccordion">
          <div class="card">
            <div class="card-header" id="headingType">
              <h2 class="mb-0">
                <button class="btn btn-link" type="button" data-bs-toggle="collapse" data-bs-target="#collapseType" aria-expanded="true" aria-controls="collapseType">
                  Filtrar por tipo
                </button>
              </h2>
            </div>

            <div id="collapseType" class="collapse" aria-labelledby="headingType" data-parent="#filterAccordion">
              <div class="card-body">
                <div class="form-group">
                  <div *ngFor="let type of errorTypes" class="form-check">
                    <input type="checkbox" class="form-check-input" [id]="type" (change)="toggleFilterType(type)" [checked]="filterType.includes(type)">
                    <label class="form-check-label" [for]="type">{{ type }}</label>
                  </div>
                </div>
              </div>
            </div>
          </div>

          <div class="card">
            <div class="card-header" id="headingModule">
              <h2 class="mb-0">
                <button class="btn btn-link collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseModule" aria-expanded="false" aria-controls="collapseModule">
                  Filtrar por módulo
                </button>
              </h2>
            </div>
            <div id="collapseModule" class="collapse" aria-labelledby="headingModule" data-parent="#filterAccordion">
              <div class="card-body">
                <div class="form-group">
                  <div *ngFor="let module of modules" class="form-check">
                    <input type="checkbox" class="form-check-input" [id]="module" (change)="toggleFilterModule(module)" [checked]="filterModule.includes(module)">
                    <label class="form-check-label" [for]="module">{{ module }}</label>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
      
      <div *ngIf="loadingTechnical">Cargando reportes técnicos...</div>
      <div *ngIf="!loadingTechnical && technicalReports.length === 0">No hay reportes técnicos.</div>
      <div *ngIf="!loadingTechnical && technicalReports.length > 0">
        <table class="table table-striped">
          <thead>
            <tr>
              <th>Tipo</th>
              <th>Módulo</th>
              <th>Descripción</th>
              <th>Pasos</th>
              <th>Archivo Adjunto</th>
              <th>Acciones</th>
            </tr>
          </thead>
          <tbody>
            <tr *ngFor="let report of technicalReports; let i = index">
              <td>{{ report.type }}</td>
              <td>{{ report.module || 'N/A' }}</td>
              <td>{{ report.description }}</td>
              <td>{{ report.steps }}</td>
              <td>
                <ng-container *ngIf="report.attachment && report.attachment.length > 0; else noAttachment">
                  <a (click)="getFile(report.attachment[0].fileName)" style="cursor: pointer; color: blue;">{{ report.attachment[0].originalName }}</a>
                </ng-container>
                <ng-template #noAttachment>No hay adjunto</ng-template>
              </td>
              <td>
                <button class="btn btn-secondary btn-sm me-2"
                        data-bs-toggle="modal"
                        [attr.data-bs-target]="'#technicalDetailsModal-' + (report._id || i)">
                  <i class="fas fa-eye"></i>
                </button>
                <button class="btn btn-info btn-sm me-2" (click)="openEditModal(report)">Editar</button>
                <button class="btn btn-danger btn-sm" (click)="confirmDeleteReport(report)">Eliminar</button>
              </td>
            </tr>
          </tbody>
        </table>
        <div class="pagination-controls">
          <button class="btn btn-secondary me-2" (click)="previousTechnicalPage()" [disabled]="currentTechnicalPage === 1">Anterior</button>
          <span class="mx-2">Página {{ currentTechnicalPage }} de {{ totalTechnicalPages }}</span>
          <button class="btn btn-secondary" (click)="nextTechnicalPage()" [disabled]="currentTechnicalPage === totalTechnicalPages">Siguiente</button>
        </div>
        
        <!-- Modales de detalle para reportes técnicos -->
        <div *ngFor="let report of technicalReports; let i = index">
          <div class="modal fade" id="technicalDetailsModal-{{report._id || i}}" tabindex="-1" role="dialog" aria-hidden="true">
            <div class="modal-dialog modal-lg modal-dialog-centered" role="document">
              <div class="modal-content">
                <div class="modal-header">
                  <h5 class="modal-title">Detalle del reporte técnico</h5>
                  <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                  <div class="mb-2"><strong>Tipo:</strong> {{ report.type }}</div>
                  <div class="mb-2"><strong>Módulo:</strong> {{ report.module || 'N/A' }}</div>
                  <div class="mb-2"><strong>Descripción:</strong><br>{{ report.description }}</div>
                  <div class="mb-2"><strong>Pasos:</strong><br>{{ report.steps || 'N/A' }}</div>
                  <div class="mb-2">
                    <strong>Adjuntos:</strong>
                    <ng-container *ngIf="report.attachment && report.attachment.length > 0; else noAttachmentModal">
                      <div>
                        <a (click)="getFile(report.attachment[0].fileName)" style="cursor: pointer; color: blue;">{{ report.attachment[0].originalName }}</a>
                      </div>
                    </ng-container>
                    <ng-template #noAttachmentModal>No hay adjunto</ng-template>
                  </div>
                </div>
                <div class="modal-footer">
                  <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Pestaña de Denuncias -->
    <div class="tab-pane fade" id="complaints" role="tabpanel" aria-labelledby="complaints-tab">
      <div class="mb-3">
        <div class="accordion" id="complaintsFilterAccordion">
          <div class="card">
            <div class="card-header" id="headingComplaintType">
              <h2 class="mb-0">
                <button class="btn btn-link" type="button" data-bs-toggle="collapse" data-bs-target="#collapseComplaintType" aria-expanded="true" aria-controls="collapseComplaintType">
                  Filtrar por tipo de denuncia
                </button>
              </h2>
            </div>
            <div id="collapseComplaintType" class="collapse" aria-labelledby="headingComplaintType" data-parent="#complaintsFilterAccordion">
              <div class="card-body">
                <div class="form-group">
                  <div class="form-check">
                    <input type="checkbox" class="form-check-input" id="publicationComplaint" (change)="toggleComplaintFilter('publication')" [checked]="complaintFilter.includes('publication')">
                    <label class="form-check-label" for="publicationComplaint">Denuncias de publicación</label>
                  </div>
                  <div class="form-check">
                    <input type="checkbox" class="form-check-input" id="userComplaint" (change)="toggleComplaintFilter('user')" [checked]="complaintFilter.includes('user')">
                    <label class="form-check-label" for="userComplaint">Denuncias de usuario</label>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <div *ngIf="loadingComplaints">Cargando denuncias...</div>
      <div *ngIf="!loadingComplaints && complaints.length === 0">No hay denuncias.</div>
      <div *ngIf="!loadingComplaints && complaints.length > 0">
        <table class="table table-striped">
          <thead>
            <tr>
              <th>Tipo</th>
              <th>Categoría</th>
              <th>Objetivo</th>
              <th>Descripción</th>
              <th>Denunciante</th>
              <th>Acciones</th>
            </tr>
          </thead>
          <tbody>
            <tr *ngFor="let complaint of complaints; let i = index">
              <td>{{ complaint.type }}</td>
              <td>
                <span class="badge bg-warning" *ngIf="complaint.category === 'publication'">
                  <i class="fas fa-newspaper me-1"></i>Publicación
                </span>
                <span class="badge bg-danger" *ngIf="complaint.category === 'user'">
                  <i class="fas fa-user me-1"></i>Usuario
                </span>
              </td>
              <td>
                <a *ngIf="complaint.category === 'publication' && complaint.publicationId" 
                   [routerLink]="['/inicio/publicacion', complaint.publicationId._id || complaint.publicationId]"
                   target="_blank"
                   class="btn btn-sm btn-outline-primary">
                  <i class="fas fa-external-link-alt"></i> Ver
                </a>
                <a *ngIf="complaint.category === 'user' && complaint.reportedUserId" 
                   [routerLink]="['/perfil', complaint.reportedUser?._id || complaint.reportedUserId._id || complaint.reportedUserId]"
                   target="_blank"
                   class="btn btn-sm btn-outline-primary">
                  <i class="fas fa-user"></i> {{ complaint.reportedUser?.name || 'Ver' }}
                </a>
              </td>
              <td>
                <span class="text-truncate d-inline-block" style="max-width: 200px;" [title]="complaint.description">
                  {{ complaint.description }}
                </span>
              </td>
              <td>
                <a *ngIf="complaint.reporter?._id" 
                   [routerLink]="['/perfil', complaint.reporter._id]"
                   class="text-primary">
                  {{ complaint.reporter?.name }} {{ complaint.reporter?.surname }}
                </a>
                <span *ngIf="!complaint.reporter?._id">
                  {{ complaint.reporter?.name || 'N/A' }}
                </span>
              </td>
              <td>
                <div class="btn-group-vertical" role="group">
                  <button class="btn btn-secondary btn-sm mb-1"
                          data-bs-toggle="modal"
                          [attr.data-bs-target]="'#complaintDetailsModal-' + (complaint._id || i)">
                    <i class="fas fa-eye"></i> Detalle
                  </button>
                  <button *ngIf="complaint.category === 'publication'" 
                          class="btn btn-danger btn-sm mb-1" 
                          (click)="confirmDeletePublication(complaint)">
                    <i class="fas fa-trash"></i> Eliminar
                  </button>
                  <button *ngIf="complaint.category === 'user'" 
                          class="btn btn-warning btn-sm mb-1" 
                          (click)="openWarningModal(complaint)">
                    <i class="fas fa-exclamation-triangle"></i> Advertir
                  </button>
                  <button class="btn btn-success btn-sm" 
                          (click)="resolveComplaint(complaint, false)">
                    <i class="fas fa-check"></i> Resolver
                  </button>
                </div>
              </td>
            </tr>
          </tbody>
        </table>
        <div class="pagination-controls">
          <button class="btn btn-secondary me-2" (click)="previousComplaintsPage()" [disabled]="currentComplaintsPage === 1">Anterior</button>
          <span class="mx-2">Página {{ currentComplaintsPage }} de {{ totalComplaintsPages }}</span>
          <button class="btn btn-secondary" (click)="nextComplaintsPage()" [disabled]="currentComplaintsPage === totalComplaintsPages">Siguiente</button>
        </div>
        
        <!-- Modales de detalle para denuncias -->
        <div *ngFor="let complaint of complaints; let i = index">
          <div class="modal fade" id="complaintDetailsModal-{{complaint._id || i}}" tabindex="-1" role="dialog" aria-hidden="true">
            <div class="modal-dialog modal-lg modal-dialog-centered" role="document">
              <div class="modal-content">
                <div class="modal-header">
                  <h5 class="modal-title">Detalle de la denuncia</h5>
                  <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                  <div class="mb-2"><strong>Categoría:</strong> {{ complaint.category === 'publication' ? 'Denuncia de publicación' : 'Denuncia de usuario' }}</div>
                  <div class="mb-2"><strong>Tipo:</strong> {{ complaint.type }}</div>
                  <div class="mb-2">
                    <strong>Denunciante:</strong> 
                    <a *ngIf="complaint.reporter?._id" 
                       [routerLink]="['/perfil', complaint.reporter._id]"
                       class="text-primary">
                      {{ complaint.reporter?.name }} {{ complaint.reporter?.surname }}
                    </a>
                    <span *ngIf="!complaint.reporter?._id">
                      {{ complaint.reporter?.name }} {{ complaint.reporter?.surname }}
                    </span>
                  </div>
                  <div class="mb-2" *ngIf="complaint.publicationId">
                    <strong>Publicación denunciada:</strong><br>
                    <a [routerLink]="['/inicio/publicacion', complaint.publicationId._id || complaint.publicationId]"
                       target="_blank"
                       class="btn btn-sm btn-outline-primary mt-1">
                      <i class="fas fa-external-link-alt me-2"></i>Ver publicación
                    </a>
                  </div>
                  <div class="mb-2" *ngIf="complaint.reportedUserId">
                    <strong>Usuario denunciado:</strong><br>
                    <a [routerLink]="['/perfil', complaint.reportedUser?._id || complaint.reportedUserId._id || complaint.reportedUserId]"
                       target="_blank"
                       class="btn btn-sm btn-outline-primary mt-1">
                      <i class="fas fa-user me-2"></i>{{ complaint.reportedUser?.name }} {{ complaint.reportedUser?.surname }}
                    </a>
                  </div>
                  <div class="mb-2"><strong>Descripción:</strong><br>{{ complaint.description }}</div>
                  <div class="mb-2"><strong>Detalles adicionales:</strong><br>{{ complaint.steps || 'N/A' }}</div>
                  <div class="mb-2">
                    <strong>Adjuntos:</strong>
                    <ng-container *ngIf="complaint.attachment && complaint.attachment.length > 0; else noAttachmentModal2">
                      <div>
                        <a (click)="getFile(complaint.attachment[0].fileName)" style="cursor: pointer; color: blue;">{{ complaint.attachment[0].originalName }}</a>
                      </div>
                    </ng-container>
                    <ng-template #noAttachmentModal2>No hay adjunto</ng-template>
                  </div>
                </div>
                <div class="modal-footer">
                  <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Modal para enviar advertencia a usuario -->
<div class="modal fade" id="warningModal" tabindex="-1" role="dialog" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered" role="document">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Enviar Advertencia al Usuario</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <p><strong>Usuario:</strong> {{ selectedComplaint?.reportedUser?.name }} {{ selectedComplaint?.reportedUser?.surname }}</p>
        <div class="form-group">
          <label for="warningMessage">Mensaje de advertencia:</label>
          <textarea class="form-control" id="warningMessage" rows="4" [(ngModel)]="warningMessage" placeholder="Escribe el mensaje de advertencia aquí..."></textarea>
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
        <button type="button" class="btn btn-warning" (click)="sendWarning()">Enviar Advertencia</button>
      </div>
    </div>
  </div>
</div>
