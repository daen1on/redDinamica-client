<div class="card mb-3 shadow-sm">
    <div class="card-body p-3">
        <!-- Header de la publicación -->
        <div class="d-flex align-items-start mb-3">
            <div class="flex-shrink-0 me-3">
                <a [routerLink]="['/perfil', publication.user?._id || publication.user]">
                    <div class="profile-picture-container">
                        <img *ngIf="!publication.user?.picture" 
                             class="profile-picture"
                             src="assets/images/user-default.png"
                             alt="Imagen por defecto">
                        <img *ngIf="publication.user?.picture" 
                             class="profile-picture"
                             [src]="url + 'get-image-user/' + publication.user.picture"
                             alt="Foto de perfil">
                    </div>
                </a>
            </div>
            <div class="flex-grow-1">
                <div class="d-flex justify-content-between align-items-start">
                    <div>
                        <h6 class="mb-1">
                            <a class="text-primary text-decoration-none fw-bold" 
                               [routerLink]="['/perfil', publication.user?._id || publication.user]">
                                <span *ngIf="publication.user?.name; else userFallback">
                                    {{publication.user.name}} {{publication.user.surname}}
                                </span>
                                <ng-template #userFallback>
                                    <span class="text-muted">Cargando usuario...</span>
                                </ng-template>
                            </a>
                        </h6>
                        <small class="text-muted">
                            {{ (publication.created_at | amFromUnix) | amLocale:'es' | amDateFormat:'LLL' }}
                        </small>
                    </div>
                    <div *ngIf="showDeleteButton && identity._id == (publication.user?._id || publication.user)">
                        <button class="btn btn-link p-1 text-secondary" 
                                data-bs-toggle="modal" 
                                [attr.data-bs-target]="'#deleteModal-' + publication._id"
                                title="Eliminar publicación">
                            <i class="fas fa-trash fa-sm"></i>
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Contenido de la publicación -->
        <div class="publication-content mb-3">
            <div class="publication-text" innerHTML="{{newLines(publication.text | linky)}}"></div>
            
            <div *ngIf="publication.file" class="publication-image mt-2">
                <img class="img-fluid rounded" 
                     [src]="url + 'get-image-post/' + publication.file"
                     alt="Imagen de publicación">
            </div>
        </div>

        <!-- Botones de interacción -->
        <div class="interaction-bar d-flex justify-content-between align-items-center mb-3">
            <div class="interaction-buttons">
                <button class="btn btn-sm interaction-btn" 
                        [class.text-danger]="hasUserLikedPublication(publication)" 
                        [class.text-dark]="!hasUserLikedPublication(publication)"
                        (click)="toggleLikePublication(publication._id)"
                        title="Me gusta">
                    <i class="fas fa-heart me-1"></i>
                    <span *ngIf="publication.likesCount && publication.likesCount > 0">{{publication.likesCount}}</span>
                </button>
                <button class="btn btn-sm interaction-btn text-primary ms-3" 
                        title="Comentar"
                        (click)="scrollToComments(publication._id)">
                    <i class="fas fa-comment me-1"></i>
                    <span *ngIf="publication.comments && publication.comments.length > 0">{{publication.comments.length}}</span>
                </button>
            </div>
        </div>

        <!-- Formulario de comentario -->
        <form [formGroup]="commentForm" 
              (ngSubmit)="onCommentSubmit(publication._id)" 
              id="comments-form-{{publication._id}}"
              class="comment-form mb-3">
            <div class="d-flex align-items-start">
                <div class="flex-shrink-0 me-2">
                    <div class="comment-avatar">
                        <img *ngIf="!identity.picture" 
                             class="img-fluid rounded-circle" 
                             src="assets/images/user-default.png"
                             alt="Tu avatar">
                        <img *ngIf="identity.picture" 
                             class="img-fluid rounded-circle"
                             [src]="url + 'get-image-user/' + identity.picture"
                             alt="Tu avatar">
                    </div>
                </div>
                <div class="flex-grow-1">
                    <div class="input-group">
                        <textarea class="form-control form-control-sm" 
                                  formControlName="text" 
                                  rows="2"
                                  placeholder="Escribe un comentario..."
                                  (focus)="setFocusPublication(publication._id)"></textarea>
                        <button type="submit" 
                                class="btn btn-primary btn-sm"
                                [disabled]="!commentForm.valid || focusPublication != publication._id">
                            <i class="fas fa-paper-plane"></i>
                        </button>
                    </div>
                </div>
            </div>
        </form>

        <!-- Lista de comentarios -->
        <div *ngIf="publication.comments && publication.comments.length > 0" 
             class="comments-section">
            <div class="comments-header mb-2 d-flex justify-content-between align-items-center">
                <small class="text-primary fw-bold">
                    <i class="fas fa-comments me-1"></i>
                    Comentarios ({{publication.comments.length}}
                    <span *ngIf="commentsPagination.totalComments > publication.comments.length">
                        de {{commentsPagination.totalComments}}
                    </span>)
                </small>
                <div class="d-flex align-items-center">
                    <!-- Notificación de nuevos comentarios -->
                    <div *ngIf="hasNewComments" class="new-comments-notification me-2">
                        <span class="badge bg-success">
                            <i class="fas fa-bell me-1"></i>
                            Nuevos comentarios
                        </span>
                    </div>
                    <!-- Botón para forzar actualización -->
                    <button class="btn btn-link p-0 text-primary" 
                            (click)="forceUpdateComments()"
                            title="Actualizar comentarios">
                        <i class="fas fa-sync-alt"></i>
                    </button>
                </div>
            </div>

            <div *ngFor="let comment of publication.comments" class="comment-item mb-2">
                <div class="d-flex align-items-start">
                    <div class="flex-shrink-0 me-2">
                        <a *ngIf="comment.user && comment.user._id" [routerLink]="['/perfil', comment.user._id]">
                            <div class="comment-avatar">
                                <img *ngIf="!comment.user?.picture" 
                                     class="img-fluid rounded-circle" 
                                     src="assets/images/user-default.png"
                                     alt="Avatar">
                                <img *ngIf="comment.user?.picture" 
                                     class="img-fluid rounded-circle"
                                     [src]="url + 'get-image-user/' + comment.user.picture"
                                     alt="Avatar">
                            </div>
                        </a>
                        <!-- Fallback si no hay usuario -->
                        <div *ngIf="!comment.user || !comment.user._id" class="comment-avatar">
                            <img class="img-fluid rounded-circle" 
                                 src="assets/images/user-default.png"
                                 alt="Avatar">
                        </div>
                    </div>
                    
                    <div *ngIf="comment.user" class="flex-grow-1">
                        <div class="comment-bubble">
                            <div class="comment-header">
                                <a *ngIf="comment.user._id" class="text-primary text-decoration-none fw-bold" 
                                   [routerLink]="['/perfil', comment.user._id]">
                                    {{comment.user.name}} {{comment.user.surname}}
                                </a>
                                <span *ngIf="!comment.user._id" class="text-muted">
                                    Usuario no disponible
                                </span>
                                <small class="text-muted ms-2">
                                    {{ (comment.created_at | amFromUnix) | amLocale:'es' | amDateFormat:'LLL' }}
                                </small>
                            </div>
                            <div class="comment-text">
                                <p class="mb-1" [innerHTML]="formatTextWithMentions(comment.text)"></p>
                            </div>
                            <div class="comment-actions d-flex justify-content-between align-items-center">
                                <div class="d-flex align-items-center">
                                    <button class="btn btn-sm interaction-btn" 
                                            [class.text-danger]="hasUserLikedComment(comment)" 
                                            [class.text-dark]="!hasUserLikedComment(comment)"
                                            (click)="toggleLikeComment(comment._id)"
                                            title="Me gusta">
                                        <i class="fas fa-heart me-1"></i>
                                        <span *ngIf="comment.likesCount && comment.likesCount > 0">{{comment.likesCount}}</span>
                                    </button>
                                    <button class="btn btn-sm interaction-btn text-primary ms-2" 
                                            (click)="toggleReplyForm(comment._id)"
                                            title="Responder">
                                        <i class="fas fa-reply me-1"></i>
                                        Responder
                                    </button>
                                    <span *ngIf="getTotalRepliesCount(comment) > 0" class="text-muted ms-2">
                                        <small>{{getTotalRepliesCount(comment)}} respuesta(s)</small>
                                    </span>
                                </div>
                                <div>
                                    <button *ngIf="comment.user && comment.user._id == identity._id"
                                            class="btn btn-link p-0 text-secondary" 
                                            (click)="deleteComment(comment._id)"
                                            title="Eliminar comentario">
                                        <i class="fas fa-trash fa-sm"></i>
                                    </button>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Formulario de respuesta -->
                        <form *ngIf="showReplyForm[comment._id]" 
                              [formGroup]="replyForm" 
                              (ngSubmit)="onReplySubmit(comment._id, publication._id)" 
                              class="reply-form mt-2">
                            <div class="d-flex align-items-start">
                                <div class="flex-shrink-0 me-2">
                                    <div class="reply-avatar">
                                        <img *ngIf="!identity?.picture" 
                                             class="img-fluid rounded-circle" 
                                             src="assets/images/user-default.png"
                                             alt="Tu avatar">
                                        <img *ngIf="identity?.picture" 
                                             class="img-fluid rounded-circle"
                                             [src]="url + 'get-image-user/' + identity.picture"
                                             alt="Tu avatar">
                                    </div>
                                </div>
                                <div class="flex-grow-1">
                                    <div class="input-group">
                                        <textarea class="form-control form-control-sm" 
                                                  formControlName="text" 
                                                  rows="2"
                                                  placeholder="Escribe una respuesta..."
                                                  style="font-size: 13px;"
                                                  [id]="'reply-textarea-' + comment._id"></textarea>
                                        <button type="submit" 
                                                class="btn btn-primary btn-sm"
                                                [disabled]="!replyForm.valid">
                                            <i class="fas fa-paper-plane"></i>
                                        </button>
                                        <button type="button" 
                                                class="btn btn-secondary btn-sm ms-1"
                                                (click)="cancelReply(comment._id)">
                                            <i class="fas fa-times"></i>
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </form>
                        
                        <!-- Botón para cargar más respuestas -->
                        <div *ngIf="repliesPagination[comment._id]?.hasMore" class="mt-2">
                            <button class="btn btn-link btn-sm p-0 text-primary" 
                                    (click)="loadMoreReplies(comment._id)"
                                    [disabled]="repliesPagination[comment._id]?.loading">
                                <i class="fas fa-chevron-down me-1"></i>
                                <span *ngIf="!repliesPagination[comment._id]?.loading">
                                    Ver más respuestas ({{repliesPagination[comment._id]?.totalReplies - (comment.replies?.length || 0)}} restantes)
                                </span>
                                <span *ngIf="repliesPagination[comment._id]?.loading">
                                    <i class="fas fa-spinner fa-spin me-1"></i>Cargando...
                                </span>
                            </button>
                        </div>
                        
                        <!-- Respuestas anidadas -->
                        <div *ngIf="comment.replies && comment.replies.length > 0" class="replies-section mt-2">
                            <div *ngFor="let reply of comment.replies" class="reply-item mb-2">
                                <div class="d-flex align-items-start">
                                    <div class="flex-shrink-0 me-2">
                                        <a *ngIf="reply.user && reply.user._id" [routerLink]="['/perfil', reply.user._id]">
                                            <div class="reply-avatar">
                                                <img *ngIf="!reply.user?.picture" 
                                                     class="img-fluid rounded-circle" 
                                                     src="assets/images/user-default.png"
                                                     alt="Avatar">
                                                <img *ngIf="reply.user?.picture" 
                                                     class="img-fluid rounded-circle"
                                                     [src]="url + 'get-image-user/' + reply.user.picture"
                                                     alt="Avatar">
                                            </div>
                                        </a>
                                        <!-- Fallback para respuestas sin usuario -->
                                        <div *ngIf="!reply.user || !reply.user._id" class="reply-avatar">
                                            <img class="img-fluid rounded-circle" 
                                                 src="assets/images/user-default.png"
                                                 alt="Avatar">
                                        </div>
                                    </div>
                                    
                                    <div *ngIf="reply.user" class="flex-grow-1">
                                        <div class="reply-bubble">
                                            <div class="reply-header">
                                                <a *ngIf="reply.user._id" class="text-primary text-decoration-none fw-bold" 
                                                   [routerLink]="['/perfil', reply.user._id]">
                                                    {{reply.user.name}} {{reply.user.surname}}
                                                </a>
                                                <span *ngIf="!reply.user._id" class="text-muted">
                                                    Usuario no disponible
                                                </span>
                                                <small class="text-muted ms-2">
                                                    {{ (reply.created_at | amFromUnix) | amLocale:'es' | amDateFormat:'LLL' }}
                                                </small>
                                            </div>
                                            <div class="reply-text">
                                                <p class="mb-1" [innerHTML]="formatTextWithMentions(reply.text)"></p>
                                            </div>
                                            <div class="reply-actions d-flex justify-content-between align-items-center">
                                                <div class="d-flex align-items-center">
                                                    <button class="btn btn-sm interaction-btn" 
                                                            [class.text-danger]="hasUserLikedComment(reply)" 
                                                            [class.text-dark]="!hasUserLikedComment(reply)"
                                                            (click)="toggleLikeComment(reply._id)"
                                                            title="Me gusta">
                                                        <i class="fas fa-heart me-1"></i>
                                                        <span *ngIf="reply.likesCount && reply.likesCount > 0">{{reply.likesCount}}</span>
                                                    </button>
                                                    <!-- Botón para responder dirigido al comentario principal -->
                                                    <button class="btn btn-sm interaction-btn text-secondary ms-2" 
                                                            (click)="replyToComment(reply._id)"
                                                            title="Responder en el hilo principal">
                                                        <i class="fas fa-reply me-1"></i>
                                                        <small>Responder</small>
                                                    </button>
                                                </div>
                                                <div>
                                                    <button *ngIf="reply.user && reply.user._id == identity._id"
                                                            class="btn btn-link p-0 text-secondary" 
                                                            (click)="deleteComment(reply._id)"
                                                            title="Eliminar respuesta">
                                                        <i class="fas fa-trash fa-sm"></i>
                                                    </button>
                                                </div>
                                            </div>
                                        </div>
                                        
                                        <!-- REMOVER: Formulario de respuesta anidada ya no se necesita -->
                                        <!-- <form *ngIf="showReplyForm[reply._id]" 
                                              [formGroup]="replyForm" 
                                              (ngSubmit)="onReplySubmit(reply._id, publication._id)" 
                                              class="reply-form mt-2">
                                            <div class="d-flex align-items-start">
                                                <div class="flex-shrink-0 me-2">
                                                    <div class="reply-avatar">
                                                        <img *ngIf="!identity?.picture" 
                                                             class="img-fluid rounded-circle" 
                                                             src="assets/images/user-default.png"
                                                             alt="Tu avatar">
                                                        <img *ngIf="identity?.picture" 
                                                             class="img-fluid rounded-circle"
                                                             [src]="url + 'get-image-user/' + identity.picture"
                                                             alt="Tu avatar">
                                                    </div>
                                                </div>
                                                <div class="flex-grow-1">
                                                    <div class="input-group">
                                                        <textarea class="form-control form-control-sm" 
                                                                  formControlName="text" 
                                                                  rows="2"
                                                                  placeholder="Escribe una respuesta..."
                                                                  style="font-size: 12px;"
                                                                  [id]="'reply-textarea-' + reply._id"></textarea>
                                                        <button type="submit" 
                                                                class="btn btn-primary btn-sm"
                                                                [disabled]="!replyForm.valid">
                                                            <i class="fas fa-paper-plane"></i>
                                                        </button>
                                                        <button type="button" 
                                                                class="btn btn-secondary btn-sm ms-1"
                                                                (click)="cancelReply(reply._id)">
                                                            <i class="fas fa-times"></i>
                                                        </button>
                                                    </div>
                                                </div>
                                            </div>
                                        </form> -->
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Botón para cargar más comentarios -->
            <div *ngIf="commentsPagination.hasMore" class="text-center mt-3">
                <button class="btn btn-outline-primary btn-sm" 
                        (click)="loadMoreComments()"
                        [disabled]="commentsPagination.loading">
                    <span *ngIf="!commentsPagination.loading">
                        <i class="fas fa-chevron-down me-1"></i>
                        Ver más comentarios ({{commentsPagination.totalComments - publication.comments.length}} restantes)
                    </span>
                    <span *ngIf="commentsPagination.loading">
                        <i class="fas fa-spinner fa-spin me-1"></i>Cargando comentarios...
                    </span>
                </button>
            </div>

            
        </div>
    </div>
</div>

<!-- Modal de eliminación -->
<div class="modal fade" id="deleteModal-{{publication._id}}" tabindex="-1" role="dialog" [attr.aria-labelledby]="'deleteModalLabel-' + publication._id" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="deleteModalLabel-{{publication._id}}">Eliminar publicación</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="alert alert-warning mb-0" role="alert">
                    <i class="fas fa-exclamation-triangle me-2"></i>
                    ¿Estás seguro que deseas eliminar esta publicación? Esta acción no se puede deshacer.
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                <button type="button" class="btn btn-danger" data-bs-dismiss="modal" (click)="deletePublication()">Eliminar</button>
            </div>
        </div>
    </div>
</div>
