<!-- resources -->
<div class="card-body">
    <div class="row">
        <div class="col">
            <div class="card mb-3 text-center">
                <div *ngIf="lesson.state" class="card-header bg-{{lesson_states[lesson.state].class}}">
                    <h5 class="mb-0 text-white">
                        {{title}} - {{lesson.title}}
                    </h5>
                </div>
                
            
            </div>
            <div *ngIf="status === 'deletedD'" class="alert alert-primary fade show text-center"
                role="alert">
                    <i class="fas fa-check-circle icon-message me-2"></i>
                    {{deletedMsg}}
            </div>
            <div *ngIf="status === 'warningD'" class="alert alert-info fade show text-center"
            role="alert">
                <i class="fas fa-check-circle icon-message me-2"></i>
                {{warningMsgF}}
            </div>
            <div *ngIf="status === 'successE'" class="alert alert-success fade show text-center"
            role="alert">
                <i class="fas fa-check-circle icon-message me-2"></i>
                {{successMsgEdit}}
            </div>
            <div *ngIf="status === 'success'" class="alert alert-success fade show text-center"
            role="alert">
                <i class="fas fa-check-circle icon-message me-2"></i>
                {{successMsg}}
            </div>
            
            
        </div>
    </div>

    

    <div *ngIf="lesson.files.length > 0 || showResources()" class="row">

        <div class="col-5">
            <div class="border rounded nav flex-column nav-pills" id="v-pills-tab" role="tablist"
                aria-orientation="vertical">

                <div *ngFor="let group of groups, let ix = index" class="nav-link" [ngClass]="{'active': ix == 0 && !addingNewGroup}"
                    id="{{removeSpaces(group)}}-tab" data-bs-toggle="pill" attr.href="#{{removeSpaces(group)}}" role="tab"
                    attr.aria-controls="{{removeSpaces(group)}}" aria-selected="true"
                    [ngClass]="{disable: loading}"
                    (click)="handleTabClick($event, group)">
                    {{group}}
                    <section *ngIf="selectedGroup == group && showResources()" class="float-right">
                        <a class="resource-edit me-1" title="Editar grupo (cambiar nombre o archivos)" aria-label="Editar grupo"
                           data-bs-toggle="tooltip" data-bs-placement="top"
                        ><i class="fas fa-edit"
                                (click)="initEditGroup($event, group)"></i></a>
                        <a class="resource-delete ms-1" title="Eliminar grupo (se borrarán sus archivos)" aria-label="Eliminar grupo"
                           data-bs-toggle="tooltip" data-bs-placement="top"
                        ><i class="fas fa-trash"
                                (click)="confirmDeleteGroup($event, group)"></i></a>
                    </section>
                </div>


                <div *ngIf="showResources()" class="nav-link" style="cursor: pointer;" 
                    [ngClass]="{'show active': lesson.files.length == 0 || addingNewGroup}" id="addGroup-tab" data-bs-toggle="pill"
                    [ngClass]="{disable: loading}" href="#addGroup" role="tab" aria-controls="addGroup" aria-selected="false"
                    (click)="handleAddGroupTabClick($event)">
                    <i class="fas fa-plus"></i> Agregar grupo de recursos
                </div>


            </div>
        </div>

        <div class="col-7">


            <div class="tab-content" id="v-pills-tabContent">
                <div *ngFor="let group of groups, let ix = index" class="tab-pane fade"
                    [ngClass]="{'show active': ix == 0 && !addingNewGroup && groups.length > 0}" id="{{removeSpaces(group)}}" role="tabpanel"
                    attr.aria-labelledby="{{removeSpaces(group)}}-tab">

                    <div class="row">
                        <div class="col">
                            <div class="card">
                                <div class="card-body">
                                    <div *ngIf="status === 'deletedF'; successMessage" class="alert alert-primary fade show text-center"
                                    role="alert">
                                        <i class="fas fa-check-circle icon-message me-2"></i>
                                        {{deletedMsgF}}
                                    </div>
                                    <section *ngIf="editMode && showResources()">
                                        <div *ngIf="status === 'error'; successMessage"
                                            class="alert alert-danger fade show text-center" role="alert">
                                            <i class="fas fa-times-circle icon-message me-2"></i>
                                            {{errorMsgEdit}}
                                        </div>

                                        <div *ngIf="status === 'success'; successMessage"
                                            class="alert alert-success fade show text-center" role="alert">
                                            <i class="fas fa-check-circle icon-message me-2"></i>
                                            {{successMsgEdit}}
                                        </div>
                                        <div *ngIf="status === 'warning'"
                                        class="alert alert-warning fade show text-center" role="alert">
                                        <i class="fas fa-check-circle icon-message me-2"></i>
                                        {{warningMsg}}
                                        </div>

                                        <div class="form-group">
                                            <label for="name"><strong>Nombre*</strong></label>
                                            <input type="text" class="form-control" id="name" [formControl]="name" [disabled]="loading"
                                                [ngClass]="{ 'is-invalid': submitted && name.errors}"
                                                autocomplete="off" (change)="onChanges()">
                                            <div *ngIf="submitted && name.errors" class="invalid-feedback">
                                                <div *ngIf="name.errors.required">
                                                    El campo nombre es obligatorio.
                                                </div>
                                            </div>

                                        </div>
                                    </section>
                                        <!-- edición de recurso-->
                                    <section *ngIf="editMode && showResources()">
                                        <div class="form-group">
                                            <label for="resourcesFiles"><strong>Archivos</strong></label>
                                            <input multiple type="file" class="form-control" name="files" [disabled]="loading"
                                                id="resourcesFiles" enctype="multipart/form-data"
                                                (change)="fileChangeEvent($event)" [formControl]="files"
                                                [ngClass]="{ 'is-invalid': submitted && files.errors || maxSizeError}">
                                            <div class="progress" *ngIf="loading || barWidth!='0%'">
                                                    <div #progress  class="progress-bar progress-bar-striped progress-bar-animated" role="progressbar" [style.width]="barWidth"
                                                     aria-valuenow="barWidth" aria-valuemin="0" aria-valuemax="100">{{barWidth}}</div>
                                                </div>
                                            <div *ngIf="submitted && files.errors || maxSizeError"
                                                class="invalid-feedback">
                                                <div *ngIf="files.errors && files.errors.required">
                                                    Debes agregar al menos un archivo.
                                                </div>
                                                <div *ngIf="maxSizeError">
                                                    El archivo es demasiado grande, el tamaño maximo permitido es de
                                                    {{MAX_FILE_SIZE}}MB.
                                                </div>

                                            </div>
                                        </div>

                                        <button type="submit" [disabled]="loading"  class="btn btn-success mb-2 float-end"
                                            (click)="onSubmit(group)">
                                            <span *ngIf="loading" class="spinner-border spinner-border-sm me-2" role="status" aria-hidden="true"></span>
                                            Guardar
                                        </button>
                                    </section>

                                    <p *ngFor="let file of getfiles(group)">
                                        <a title="Descargar : {{file.fileName}}"
                                            href="{{this.url + 'get-lesson/' + file.fileName}}" target="_blank">
                                            <i class="fas fa-paperclip"></i>
                                            {{file.fileName}}
                                        </a>
                                        <a *ngIf="editMode && showResources()"
                                            class="resource-delete mx-1 float-right text-muted" title="Eliminar recurso"
                                            aria-label="Eliminar recurso" data-bs-toggle="tooltip" data-bs-placement="top"
                                            (click)="confirmDeleteFile(file._id, file.fileName)"><i class="fas fa-trash"></i></a>
                                    </p>
                                </div>
                            </div>
                        </div>
                    </div>

                </div>
                <!--need to pop up a modal once it abruptly exits-->
                <div *ngIf="showResources()" class="tab-pane fade"
                    [ngClass]="{'show active': lesson.files.length == 0 || addingNewGroup}" id="addGroup" role="tabpanel"
                    aria-labelledby="addGroup-tab">



                    <div class="row">
                        <div class="col">
                            <div class="card">
                                <div class="card-body">
                                    <div *ngIf="addingNewGroup" class="alert alert-info d-flex align-items-center" role="alert">
                                        <i class="fas fa-info-circle me-2"></i>
                                        <div>
                                            Estás creando un <strong>nuevo grupo de recursos</strong>. 1) Escribe el <strong>Nombre</strong> del grupo. 2) Selecciona uno o más <strong>Archivos</strong>. 3) Presiona <strong>Guardar</strong>.
                                        </div>
                                    </div>

                                    <div *ngIf="status === 'error'; successMessage"
                                        class="alert alert-danger fade show text-center" role="alert">
                                        <i class="fas fa-times-circle icon-message me-2"></i>
                                        {{errorMsg}}
                                    </div>

                                    <div *ngIf="status === 'deleted'; successMessage" class="alert alert-primary fade show text-center"
                                    role="alert">
                                        <i class="fas fa-check-circle icon-message me-2"></i>
                                        {{deletedMsg}}
                                    </div>
                                    <div *ngIf="status === 'success'; successMessage"
                                        class="alert alert-success fade show text-center" role="alert">
                                        <i class="fas fa-check-circle icon-message me-2"></i>
                                        {{successMsg}}
                                    </div>
                                    <div *ngIf="status === 'warning'; successMessage"
                                        class="alert alert-warning fade show text-center" role="alert">
                                        <i class="fas fa-check-circle icon-message me-2"></i>
                                        {{warningMsg}}
                                    </div>
                                    <form>
                                        <div class="form-group">
                                            <label for="name"><strong>Nombre*</strong></label>
                                            <input type="text" class="form-control" id="name" [formControl]="name" [disabled]="loading"
                                                [ngClass]="{ 'is-invalid': submitted && name.errors}"
                                                autocomplete="off" placeholder="Ej: Primer modelo de lección" (change)="onChanges()" (input)="onChanges()">
                                            <div *ngIf="submitted && name.errors" class="invalid-feedback">
                                                <div *ngIf="name.errors.required">
                                                    El campo nombre es obligatorio.
                                                </div>
                                            </div>

                                        </div>

                                        <div class="form-group" >
                                            <label for="resourcesFiles"><strong>Archivos</strong></label>
                                            <input multiple type="file" class="form-control" name="files" [disabled]="loading"
                                                id="resourcesFiles" enctype="multipart/form-data"
                                                (change)="fileChangeEvent($event)" [formControl]="files"
                                                [ngClass]="{ 'is-invalid': submitted && files.errors || maxSizeError}">
                                            <small class="form-text text-muted">Puedes seleccionar varios archivos a la vez.</small>
                                            <div class="progress" *ngIf="loading || barWidth!='0%'">
                                                    <div #progress  class="progress-bar progress-bar-striped progress-bar-animated" role="progressbar" [style.width]="barWidth"
                                                     aria-valuenow="barWidth" aria-valuemin="0" aria-valuemax="100">{{barWidth}}</div>
                                            </div>
                                            <div *ngIf="submitted && files.errors || maxSizeError"
                                                class="invalid-feedback">
                                                <div *ngIf="files.errors && files.errors.required">
                                                    Debes agregar al menos un archivo.
                                                </div>
                                                <div *ngIf="maxSizeError">
                                                    El archivo es demasiado grande, el tamaño maximo permitido es de
                                                    {{MAX_FILE_SIZE}}MB.
                                                </div>

                                            </div>
                                        </div>

                                        <button  [disabled]="loading"  type="submit" class="btn btn-success mb-2 float-end"
                                            (click)="onSubmit()">
                                            <span *ngIf="loading" class="spinner-border spinner-border-sm me-2" role="status" aria-hidden="true"></span>
                                            Guardar
                                        </button>

                                    </form>

                                </div>
                            </div>
                        </div>
                    </div>
                </div>


            </div>
        </div>

    </div>

    <div *ngIf="lesson.files.length <= 0 && !showResources()" class="row">
        <div class="col">
            <div class="card">
                <div class="card-body text-start">
                    <h4 class="text-muted">
                        No se han agregado recursos a esta lección.
                    </h4>
                </div>
            </div>
        </div>
    </div>
</div>
<!-- /resources -->
<!-- Modal Confirmar Salida durante carga/cambios -->
<div class="modal fade" id="confirmLeaveModal" tabindex="-1" aria-labelledby="confirmLeaveTitle" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="confirmLeaveTitle">¿Salir de esta página?</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="alert alert-warning mb-0" role="alert">
                    <i class="fas fa-exclamation-triangle me-2"></i>
                    {{ confirmLeaveMessage || 'Tienes cambios sin guardar o una carga en progreso. Si sales ahora, podrías perder los cambios o cancelar la carga.' }}
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal" data-cancel>Cancelar</button>
                <button type="button" class="btn btn-primary" data-confirm>Salir</button>
            </div>
        </div>
    </div>
</div>