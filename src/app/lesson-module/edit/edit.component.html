<!-- edit -->
<div class="card-body">

    <div class="row">
        <div class="col">
            <div class="card mb-3 text-center">
                <div *ngIf="lesson.state" class="card-header bg-{{lesson_states[lesson.state].class}}">
                    <h5 class="mb-0 text-white">
                        {{title}} - {{lesson.title}}
                    </h5>
                </div>
            </div>
        </div>
    </div>

    <div *ngIf="status === 'error'; successMessage" class="alert alert-danger fade show text-center" role="alert">
        <i class="fas fa-times-circle icon-message me-2"></i>
        {{errorMsg}}
    </div>

    <div *ngIf="status === 'success'; successMessage" class="alert alert-success fade show text-center" role="alert">
        <i class="fas fa-check-circle icon-message me-2"></i>
        {{successMsg}}
    </div>

    <form [formGroup]="lessonForm" (ngSubmit)="onSubmit()" (input)="onChanges()">
        <div *ngIf="lesson.resume != undefined" class="row">
            <div class="col-7">
                <div class="card">
                    <div class="card-body">
                        <div class="form-group">
                            <label for="text" class="form-label">
                                <h5>Título*</h5>
                            </label>

                            <textarea class="form-control" id="source" rows="3" formControlName="title"
                                [ngClass]="{ 'is-invalid': submitted && f.title.errors }">
                            </textarea>
                            <div *ngIf="submitted && f.title.errors" class="invalid-feedback">
                                <div *ngIf="f.title.errors.required">
                                    El campo título es obligatorio.
                                </div>
                            </div>
                        </div>
                        <div class="form-group">
                            <label for="text" class="form-label">
                                <h5>Resumen*</h5>
                            </label>

                            <textarea class="form-control" id="source" rows="5" formControlName="resume"
                                [ngClass]="{ 'is-invalid': submitted && f.resume.errors }">
                                    </textarea>
                            <div *ngIf="submitted && f.resume.errors" class="invalid-feedback">
                                <div *ngIf="f.resume.errors.required">
                                    El campo resumen es obligatorio.
                                </div>
                            </div>
                        </div>

                        <div class="form-group">
                            <label for="text" class="form-label">
                                <h5>Justificación*</h5>
                            </label>

                            <textarea class="form-control" id="source" rows="5" formControlName="justification"
                                [ngClass]="{ 'is-invalid': submitted && f.justification.errors }">
                                    </textarea>
                            <div *ngIf="submitted && f.justification.errors" class="invalid-feedback">
                                <div *ngIf="f.justification.errors.required">
                                    El campo justificación es obligatorio.
                                </div>
                            </div>
                        </div>

                        <div class="form-group">
                            <label for="text" class="form-label">
                                <h5>Referencias*</h5>
                            </label>

                            <textarea class="form-control" id="source" rows="5" formControlName="references"
                                [ngClass]="{ 'is-invalid': submitted && f.references.errors }">
                                </textarea>
                            <div *ngIf="submitted && f.references.errors" class="invalid-feedback">
                                <div *ngIf="f.references.errors.required">
                                    El campo referencias es obligatorio.
                                </div>
                            </div>
                        </div>


                    </div>
                </div>
            </div>

            <div class="col-5">
                <div class="card mb-3">
                    <div class="card-body">

                        <div class="form-group">
                            <label for="title" class="form-label">
                                <strong>Estado</strong>
                            </label>

                            <div class="">
                                <select class="form-control" id="level" formControlName="state"
                                    [ngClass]="{ 'is-invalid': submitted && f.state.errors }">
                                    <option value="proposed">Propuesta</option>
                                    <option value="assigned">Asignada</option>
                                    <option value="development">Desarrollo</option>
                                    <option value="test">Prueba</option>
                                    <option value="completed">Terminada</option>
                                </select>
                                <div *ngIf="submitted && f.state.errors">
                                    <div *ngIf="f.state.errors.required" class="invalid-feedback">
                                        El campo estado es obligatorio.
                                    </div>
                                </div>
                                <div *ngIf="f.state.value =='completed'">
                                    <small class="text-warning">
                                        Recuerda que al menos debe haber un recurso de tipo texto y un modelo para dar
                                        por terminada la lección.
                                    </small>
                                </div>
                            </div>
                        </div>



                    </div>
                </div>

                <div class="card mb-3">
                    <div class="card-body">
                        <h6 class="card-title">
                            <strong>Áreas de conocimiento</strong>
                        </h6>
                        
                        <div class="card-text">
                            <ng-select [items]="areas" bindLabel="name" formControlName="areas" [multiple]="true"
                                [hideSelected]="true" notFoundText="No se encontro">
                            </ng-select>                            
                        </div>

                        <h6 class="card-title mt-2">
                            <strong>Niveles Académicos<span class="text-danger">*</span></strong>
                        </h6>
                        
                        <!-- Chips de niveles seleccionados -->
                        <div class="selected-items-container mb-2" *ngIf="selectedLevels.length > 0">
                            <span *ngFor="let level of selectedLevels" 
                                  class="badge bg-success me-1 mb-1 selected-chip">
                                {{level.value}}
                                <button type="button" 
                                        class="btn-close btn-close-white ms-1" 
                                        (click)="removeLevel(level)"
                                        aria-label="Eliminar">
                                </button>
                            </span>
                        </div>

                        <!-- Input de autocompletado -->
                        <div class="level-autocomplete position-relative">
                            <input type="text" 
                                   class="form-control" 
                                   [(ngModel)]="levelInput"
                                   [ngModelOptions]="{standalone: true}"
                                   (input)="onLevelInputChange()"
                                   [ngClass]="{'is-invalid': submitted && f['level'].errors}"
                                   placeholder="Escribe para buscar los niveles académicos."
                                   autocomplete="off">
                            
                            <!-- Dropdown de sugerencias -->
                            <div *ngIf="showLevelDropdown" 
                                 class="dropdown-menu show position-absolute w-100 mt-1" 
                                 style="z-index: 1050; max-height: 200px; overflow-y: auto;">
                                
                                <button *ngFor="let level of filteredLevels" 
                                        type="button"
                                        class="dropdown-item" 
                                        (click)="selectLevel(level)">
                                    <i class="fas fa-graduation-cap me-2"></i>
                                    {{level.value}}
                                </button>
                            </div>
                        </div>

                        <small class="form-text text-muted">
                            Seleccionar uno o más niveles académicos.
                        </small>

                        <div *ngIf="submitted && f['level'].errors" class="invalid-feedback d-block">
                            Debes seleccionar al menos un nivel académico.
                        </div>

                        <!-- Estilos inline para los chips -->
                        <style>
                            .selected-chip {
                                display: inline-flex;
                                align-items: center;
                                padding: 0.375rem 0.75rem;
                                font-size: 0.875rem;
                                border-radius: 0.375rem;
                            }
                            
                            .selected-chip .btn-close {
                                font-size: 0.75rem;
                                padding: 0;
                                margin: 0;
                                width: 1rem;
                                height: 1rem;
                                opacity: 0.8;
                            }
                            
                            .selected-chip .btn-close:hover {
                                opacity: 1;
                            }
                        </style>
                    </div>
                </div>

                <div class="card mb-3">
                    <div class="card-body proposed-by; text-color: #5078a0 !important">
                        <div class="card-title">
                            <strong>Propuesto por</strong>
                        </div>
                        <div class="card-text">
                            <div class="row p-1">
                                <div class="col-auto pe-0">
                                    <a class="text-primary">
                                        <button [routerLink]="['/perfil', lesson.author._id]"
                                            class="btn flex-shrink-0 rounded-circle  overflow-hidden p-0"
                                            style="width: 40px; height:40px;">
                                            <img *ngIf="!lesson.author.picture" class="img-fluid"
                                                src="assets/images/user-default.png">
                                            <img *ngIf="lesson.author.picture" class="img-fluid"
                                                src="{{this.url+'get-image-user/'+ lesson.author.picture}}">
                                        </button>
                                    </a>
                                </div>

                                <div class="col rounded px-2">
                                    <h6 class="mb-1">
                                        <a [routerLink]="['/perfil', lesson.author._id]" class="text-primary">
                                            <strong>
                                                {{lesson.author.name}} {{lesson.author.surname}}
                                            </strong>
                                            <br>
                                            <small
                                                class=" text-muted">{{ (lesson.created_at | amFromUnix) | amLocale:'es' | amDateFormat:'LLL' }}</small>
                                        </a>
                                    </h6>
                                </div>
                            </div>
                        </div>
                        <style>
                            /* Forzar texto blanco en modo oscuro para bloque Propuesto por */
                            @media (prefers-color-scheme: dark) {
                                .proposed-by, .proposed-by *:not(img) { color: #fff !important; }
                            }
                            [data-bs-theme="dark"] .proposed-by,
                            [data-bs-theme="dark"] .proposed-by *:not(img) {
                                color: #fff !important;
                            }
                            .bg-dark .proposed-by,
                            .bg-dark .proposed-by *:not(img),
                            .text-bg-dark .proposed-by,
                            .text-bg-dark .proposed-by *:not(img),
                            .card.bg-dark .proposed-by,
                            .card.bg-dark .proposed-by *:not(img) {
                                color: #fff !important;
                            }
                        </style>
                    </div>
                </div>

                <div class="form-group">
                    <button type="submit" class="btn btn-success w-100">Guardar cambios</button>
                </div>

                <!-- Modal confirmación para estado completado -->
                <ng-template #confirmCompletedTpl let-modal>
                    <div class="modal-header">
                        <h5 class="modal-title">Confirmar envío para publicación</h5>
                        <button type="button" class="btn-close" aria-label="Cerrar" (click)="cancelCompleted()"></button>
                    </div>
                    <div class="modal-body">
                        <p class="mb-2">
                            Vas a marcar esta lección como <strong>Terminada</strong> y enviar para su publicación.
                        </p>
                        <ul class="mb-0">
                            <li>Una vez enviada para ser publicada, <strong>no podrás editar</strong> la lección.</li>
                            <li>El líder ni los integrantes <strong>no tendrán acceso</strong> a Conversación ni a Comentarios del facilitador.</li>
                        </ul>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-outline-secondary" (click)="cancelCompleted()">Cancelar</button>
                        <button type="button" class="btn btn-primary" (click)="confirmCompletedAndSave()">Entiendo, continuar</button>
                    </div>
                </ng-template>
            </div>


        </div>



    </form>



</div>
<!-- /edit -->